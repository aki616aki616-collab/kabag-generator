<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KABAG å•†å“ãƒšãƒ¼ã‚¸ HTMLç”Ÿæˆã‚¢ãƒ—ãƒª</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .app-container {
      display: flex;
      height: 100vh;
    }
    
    /* å·¦å´ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-panel {
      width: 50%;
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
      background: #fff;
      border-right: 2px solid #e0e0e0;
    }
    
    /* å³å´ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    .preview-panel {
      width: 50%;
      height: 100vh;
      overflow-y: auto;
      background: #fafafa;
    }
    .preview-header {
      position: sticky;
      top: 0;
      background: #333;
      color: #fff;
      padding: 10px 20px;
      font-weight: bold;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .preview-content {
      padding: 20px;
    }
    .preview-iframe {
      width: 100%;
      height: calc(100vh - 50px);
      border: none;
      background: #fff;
    }
    
    h1 {
      text-align: center;
      color: #F6A800;
      margin-bottom: 20px;
      font-size: 1.3em;
    }
    h2 {
      font-size: 1em;
      border-left: 4px solid #F6A800;
      padding-left: 12px;
      margin: 25px 0 12px 0;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.85em;
    }
    input[type="text"], input[type="url"], textarea, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 12px;
    }
    input[type="text"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #F6A800;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .checkbox-group {
      background: #fafafa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      font-weight: normal;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }
    .dynamic-list {
      background: #fafafa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    .dynamic-item {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid #e0e0e0;
      position: relative;
    }
    .dynamic-item .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4444;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .dynamic-item .delete-btn:hover {
      background: #cc0000;
      transform: scale(1.1);
    }
    .color-item {
      display: flex;
      align-items: center;
      padding-right: 40px;
    }
    .color-item .color-input {
      flex: 1;
      margin-bottom: 0;
    }
    .spec-other-item {
      padding-right: 40px;
    }
    .spec-other-inputs {
      display: flex;
      gap: 10px;
    }
    .spec-other-inputs input {
      flex: 1;
      margin-bottom: 0;
    }
    .spec-other-inputs .spec-other-label {
      flex: 0.4;
    }
    .spec-other-inputs .spec-other-value {
      flex: 0.6;
    }
    /* ç”»åƒé¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .image-grid-item {
      position: relative;
      cursor: pointer;
      border-radius: 6px;
      overflow: hidden;
    }
    .image-grid-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .image-grid-item.selected img {
      border-color: #4CAF50;
    }
    .image-grid-item.used img {
      opacity: 0.4;
    }
    .image-grid-item.used::after {
      content: 'è¿½åŠ æ¸ˆ';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
    }
    .image-grid-item .checkmark {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #4CAF50;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .image-grid-item.selected .checkmark {
      display: flex;
    }
    .add-btn {
      background: #F6A800;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .add-btn:hover {
      background: #e09700;
    }
    .inline-group {
      display: flex;
      gap: 12px;
    }
    .inline-group > div {
      flex: 1;
    }
    .output-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    .output-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: bold;
    }
    .copy-btn {
      background: #4CAF50;
      color: #fff;
    }
    .copy-btn:hover {
      background: #45a049;
    }
    .download-btn {
      background: #2196F3;
      color: #fff;
    }
    .download-btn:hover {
      background: #1e88e5;
    }
    .copy-success {
      text-align: center;
      color: #4CAF50;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
    .other-input {
      display: none;
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .other-input.active {
      display: block;
    }
    .preview-mode-btn {
      background: #F6A800;
      color: #fff;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .preview-mode-btn:hover {
      background: #e09700;
    }
    
    /* ç”»åƒã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .image-item-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .image-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #f5f5f5;
    }
    .image-thumbnail-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 6px;
      border: 1px dashed #ccc;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #999;
      text-align: center;
    }
    .image-inputs {
      flex: 1;
    }
    .move-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .move-btn {
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .move-btn:hover {
      background: #F6A800;
      color: #fff;
    }
    .dynamic-item.dragging {
      opacity: 0.5;
      border: 2px dashed #F6A800;
    }
    .dynamic-item.drag-over {
      border-top: 3px solid #F6A800;
    }
    .auto-generate-btn {
      background: #9c27b0;
      color: #fff;
      border: none;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      margin-left: 8px;
    }
    .auto-generate-btn:hover {
      background: #7b1fa2;
    }
    .caption-suggest-popup {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 2px solid #9c27b0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 350px;
      overflow-y: auto;
    }
    .caption-suggest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #9c27b0;
      color: #fff;
      font-size: 13px;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    .caption-suggest-header button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      padding: 0 5px;
    }
    .caption-suggest-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .caption-suggest-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
      line-height: 1.5;
    }
    .caption-suggest-item:hover {
      background: #f3e5f5;
    }
    .caption-suggest-item.selected {
      background: #e0e0e0;
      color: #666;
    }
    .caption-suggest-item:last-child {
      border-bottom: none;
    }
    .image-inputs {
      position: relative;
    }
    .load-tab-btn {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #F6A800;
      background: #fff;
      color: #F6A800;
      font-weight: bold;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .load-tab-btn:hover {
      background: #fff8e1;
    }
    .load-tab-btn.active {
      background: #F6A800;
      color: #fff;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 1024px) {
      .app-container {
        flex-direction: column;
      }
      .input-panel, .preview-panel {
        width: 100%;
        height: auto;
        min-height: 50vh;
      }
      .preview-panel {
        border-top: 2px solid #e0e0e0;
      }
    }
  </style>
</head>
<body>

<div class="app-container">
  
  <!-- å·¦å´ï¼šå…¥åŠ›ãƒ‘ãƒãƒ« -->
  <div class="input-panel">
    <h1>ğŸ¦› KABAG HTMLç”Ÿæˆã‚¢ãƒ—ãƒª</h1>
    
    <!-- HTMLã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div style="background: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #F6A800;">
      <h2 style="margin-top: 0; border-left-color: #F6A800;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</h2>
      
      <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button type="button" id="tabNewPage" class="load-tab-btn active" onclick="switchLoadTab('newPage')">æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ã‚‰æ–°è¦ä½œæˆ</button>
        <button type="button" id="tabEditHtml" class="load-tab-btn" onclick="switchLoadTab('editHtml')">ä½œæˆæ¸ˆã¿HTMLã‚’ç·¨é›†</button>
      </div>
      
      <!-- æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ã‚‰æ–°è¦ä½œæˆ -->
      <div id="loadTabNewPage">
        <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">å•†å“ãƒšãƒ¼ã‚¸ã§ã€Œå³ã‚¯ãƒªãƒƒã‚¯ã€â†’ã€Œãƒšãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã€â†’ å…¨é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ â†’ ä¸‹ã«è²¼ã‚Šä»˜ã‘</p>
        <textarea id="htmlSource" placeholder="HTMLã‚½ãƒ¼ã‚¹ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." style="width: 100%; height: 100px; font-size: 12px; font-family: monospace;"></textarea>
        <button type="button" class="add-btn" onclick="parseHTMLSource()" style="width: 100%; margin-top: 10px; padding: 12px; font-size: 14px;">ğŸ” è§£æã—ã¦èª­ã¿è¾¼ã‚€</button>
      </div>
      
      <!-- ä½œæˆæ¸ˆã¿HTMLã‚’ç·¨é›† -->
      <div id="loadTabEditHtml" style="display: none;">
        <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">ã“ã®ã‚¢ãƒ—ãƒªã§ä½œæˆã—ãŸHTMLã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã•ã‚Œã¾ã™</p>
        <textarea id="editHtmlSource" placeholder="ä½œæˆæ¸ˆã¿ã®HTMLã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..." style="width: 100%; height: 100px; font-size: 12px; font-family: monospace;"></textarea>
        <button type="button" class="add-btn" onclick="loadCreatedHTML()" style="width: 100%; margin-top: 10px; padding: 12px; font-size: 14px; background: #4CAF50;">ğŸ“‚ HTMLã‚’èª­ã¿è¾¼ã‚“ã§ç·¨é›†</button>
      </div>
      
      <!-- è§£æçµæœï¼šç”»åƒé¸æŠ -->
      <div id="extractedImages" style="display: none; margin-top: 15px;">
        <p style="font-weight: bold; margin-bottom: 10px;">â–  æŠ½å‡ºã•ã‚ŒãŸç”»åƒï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰</p>
        <div id="imageGrid" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto;"></div>
        <div style="margin-top: 10px;">
          <button type="button" class="add-btn" onclick="applySelectedImages('detail')" style="margin-right: 5px;">å•†å“è©³ç´°ã«è¿½åŠ </button>
          <button type="button" class="add-btn" onclick="applySelectedImages('slider')" style="background: #2196F3;">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«è¿½åŠ </button>
        </div>
      </div>
      
      <!-- è§£æçµæœï¼šã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œ -->
      <div id="extractedCaptionsDiv" style="display: none; margin-top: 15px;">
        <p style="font-weight: bold; margin-bottom: 10px;">â–  ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œï¼ˆç”»åƒè¿½åŠ æ™‚ã«é¸æŠå¯èƒ½ï¼‰</p>
        <div id="captionsList" style="background: #fff; padding: 10px; border-radius: 6px; max-height: 120px; overflow-y: auto; font-size: 12px;"></div>
      </div>
      
      <!-- è§£æçµæœï¼šå•†å“ãƒã‚¤ãƒ³ãƒˆææ¡ˆ -->
      <div id="extractedPoints" style="display: none; margin-top: 15px;">
        <p style="font-weight: bold; margin-bottom: 10px;">â–  æ¤œå‡ºã•ã‚ŒãŸå•†å“ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒã‚§ãƒƒã‚¯ã—ã¦åæ˜ ï¼‰</p>
        <div id="pointsList" style="background: #fff; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto;"></div>
        <button type="button" class="add-btn" onclick="applySelectedPoints()" style="width: 100%; margin-top: 10px;">ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’åæ˜ </button>
      </div>
    </div>
    
    <!-- åŸºæœ¬æƒ…å ± -->
    <h2>åŸºæœ¬æƒ…å ±</h2>
    <label>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå°ã•ã„æ–‡å­—ï¼‰</label>
    <input type="text" id="productSubtitle" placeholder="ä¾‹ï¼šæœ¬ã‚’èª­ã‚€ã®ãŒæ„‰ã—ã¿ã«ãªã‚‹" oninput="updatePreview()">
    
    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼åï¼ˆä¸­ã‚µã‚¤ã‚ºï¼‰</label>
    <input type="text" id="productCategory" placeholder="ä¾‹ï¼šãƒ¬ã‚¶ãƒ¼ãƒ–ãƒƒã‚¯ã‚«ãƒãƒ¼" oninput="updatePreview()">
    
    <label>å•†å“åï¼ˆå¤§ãã„æ–‡å­—ï¼‰</label>
    <input type="text" id="productName" placeholder="ä¾‹ï¼šbunko" oninput="updatePreview()">
    
    <label>YouTubeå‹•ç”»URLï¼ˆä»»æ„ï¼‰</label>
    <input type="url" id="youtubeUrl" placeholder="ä¾‹ï¼šhttps://www.youtube.com/embed/XXXXX" oninput="extractYoutubeUrl(this); updatePreview()">
    <p style="font-size: 0.75em; color: #888; margin-top: -8px; margin-bottom: 12px;">â€»åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ã‚‚URLã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™</p>
    
    <!-- è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨ -->
    <h2>è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨</h2>
    <div class="checkbox-group" id="beforePurchaseCheckboxes">
      <label><input type="checkbox" value="17ã‚¤ãƒ³ãƒã®PC åç´OK" onchange="updatePreview()"> 17ã‚¤ãƒ³ãƒã®PC åç´OK</label>
      <label><input type="checkbox" value="15ã‚¤ãƒ³ãƒã®PC åç´OK" onchange="updatePreview()"> 15ã‚¤ãƒ³ãƒã®PC åç´OK</label>
      <label><input type="checkbox" value="13ã‚¤ãƒ³ãƒã®PC åç´OK" onchange="updatePreview()"> 13ã‚¤ãƒ³ãƒã®PC åç´OK</label>
      <label><input type="checkbox" value="A4ãƒ•ã‚¡ã‚¤ãƒ« åç´OK" onchange="updatePreview()"> A4ãƒ•ã‚¡ã‚¤ãƒ« åç´OK</label>
      <label><input type="checkbox" value="ãƒšãƒƒãƒˆãƒœãƒˆãƒ«åç´OK" onchange="updatePreview()"> ãƒšãƒƒãƒˆãƒœãƒˆãƒ«åç´OK</label>
      <label><input type="checkbox" value="30æ—¥é–“è¿”é‡‘ä¿è¨¼â€¼ï¸" checked onchange="updatePreview()"> 30æ—¥é–“è¿”é‡‘ä¿è¨¼â€¼ï¸</label>
      <label><input type="checkbox" value="å…¨å›½é€æ–™ç„¡æ–™â€¼ï¸" checked onchange="updatePreview()"> å…¨å›½é€æ–™ç„¡æ–™â€¼ï¸</label>
    </div>
    <div class="dynamic-list" id="beforePurchaseList">
      <p style="font-size: 0.85em; color: #666; margin: 0 0 8px 0;">ãã®ä»–ã®é …ç›®ï¼š</p>
    </div>
    <button type="button" class="add-btn" onclick="addBeforePurchaseItem()">+ é …ç›®ã‚’è¿½åŠ </button>
    
    <!-- ã‚ˆãã‚ã‚‹è³ªå• -->
    <h2>ã‚ˆãã‚ã‚‹è³ªå•</h2>
    <div class="dynamic-list" id="faqList">
      <div class="dynamic-item" data-default="true">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <label>è³ªå•</label>
        <input type="text" class="faq-q" value="åç´ã§ãã‚‹ãƒ‘ã‚½ã‚³ãƒ³ã®ã‚µã‚¤ã‚ºã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚" oninput="updatePreview()">
        <label>å›ç­”</label>
        <textarea class="faq-a" oninput="updatePreview()">15ã‚¤ãƒ³ãƒã¾ã§åç´å¯èƒ½ã§ã™ã€‚</textarea>
      </div>
      <div class="dynamic-item" data-default="true">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <label>è³ªå•</label>
        <input type="text" class="faq-q" value="é›¨ã«æ¿¡ã‚Œã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ" oninput="updatePreview()">
        <label>å›ç­”</label>
        <textarea class="faq-a" oninput="updatePreview()">æ’¥æ°´åŠ å·¥ã®ç”Ÿåœ°ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€æ¿¡ã‚Œã«ãã„ç´ æã§ã™ã€‚</textarea>
      </div>
      <div class="dynamic-item" data-default="true">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <label>è³ªå•</label>
        <input type="text" class="faq-q" value="æ´—æ¿¯ã¯ã§ãã¾ã™ã‹ï¼Ÿ" oninput="updatePreview()">
        <label>å›ç­”</label>
        <textarea class="faq-a" oninput="updatePreview()">æ´—æ¿¯ã¯ã§ãã¾ã›ã‚“ã€‚</textarea>
      </div>
    </div>
    <button type="button" class="add-btn" onclick="addFaqItem()">+ è³ªå•ã‚’è¿½åŠ </button>
    
    <!-- å•†å“è©³ç´°ç”»åƒ -->
    <h2>å•†å“è©³ç´°ï¼ˆç”»åƒï¼‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
    <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">â€»ãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯â–²â–¼ãƒœã‚¿ãƒ³ã§ä¸¦ã³æ›¿ãˆå¯èƒ½ / 1ç•ªç›®ã®ç”»åƒã¯ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã«ãªã‚Šã¾ã™</p>
    <div class="dynamic-list" id="productDetailList">
      <div class="dynamic-item" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event, 'productDetailList')" ondragend="dragEnd(event)" data-index="0">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <div class="image-item-wrapper">
          <div class="move-buttons">
            <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
            <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
          </div>
          <div class="image-thumbnail-placeholder" id="thumb-detail-0">ç”»åƒ<br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div class="image-inputs">
            <label>ç”»åƒURL</label>
            <input type="url" class="detail-img" placeholder="https://cdn.shopify.com/..." oninput="updatePreview(); updateThumbnail(this, 'detail')">
            <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
            <textarea class="detail-caption" placeholder="ä¾‹ï¼šã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«ç´ æã‚’æ„Ÿã˜ã¦ã‚‚ã‚‰ãˆã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€‚" oninput="updatePreview()"></textarea>
          </div>
        </div>
      </div>
    </div>
    <button type="button" class="add-btn" onclick="addDetailItem()">+ ç”»åƒã‚’è¿½åŠ </button>
    
    <!-- ã‚µã‚¤ã‚ºãƒ»ç´ æ -->
    <h2>ã‚µã‚¤ã‚ºãƒ»ç´ æ</h2>
    <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">â€»ç©ºæ¬„ã®é …ç›®ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</p>
    
    <div class="inline-group">
      <div>
        <label>å®¹é‡</label>
        <input type="text" id="capacity" placeholder="ä¾‹ï¼š11L" oninput="updatePreview()">
      </div>
      <div>
        <label>é‡ã•</label>
        <input type="text" id="weight" placeholder="ä¾‹ï¼š820g" oninput="updatePreview()">
      </div>
    </div>
    
    <label>ã‚µã‚¤ã‚º <button type="button" class="auto-generate-btn" onclick="generateSizeSuggest()">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
    <input type="text" id="size" placeholder="ä¾‹ï¼šé«˜ã•37cm Ã— æ¨ª28cm Ã— ãƒãƒ13cm" oninput="updatePreview()">
    
    <label>ç´ æï¼ˆæœ¬ä½“ï¼‰</label>
    <select id="materialMain" onchange="toggleMaterialOther('Main'); updatePreview()">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
      <option value="ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«">ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«</option>
      <option value="ãƒŠã‚¤ãƒ­ãƒ³">ãƒŠã‚¤ãƒ­ãƒ³</option>
      <option value="ãƒãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒŠã‚¤ãƒ­ãƒ³">ãƒãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒŠã‚¤ãƒ­ãƒ³</option>
      <option value="ãƒãƒ³ãƒ—">ãƒãƒ³ãƒ—</option>
      <option value="ç‰›é©">ç‰›é©</option>
      <option value="other">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
    </select>
    <div class="other-input" id="otherMaterialMain">
      <input type="text" id="materialMainOther" placeholder="ç´ æã‚’å…¥åŠ›" oninput="updatePreview()">
    </div>
    
    <label>ç´ æï¼ˆè£åœ°ï¼‰</label>
    <select id="materialLining" onchange="toggleMaterialOther('Lining'); updatePreview()">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
      <option value="ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«">ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«</option>
      <option value="ãƒŠã‚¤ãƒ­ãƒ³">ãƒŠã‚¤ãƒ­ãƒ³</option>
      <option value="ãƒªãƒƒãƒ—ã‚¹ãƒˆãƒƒãƒ—ãƒŠã‚¤ãƒ­ãƒ³">ãƒªãƒƒãƒ—ã‚¹ãƒˆãƒƒãƒ—ãƒŠã‚¤ãƒ­ãƒ³</option>
      <option value="ãƒãƒ³ãƒ—">ãƒãƒ³ãƒ—</option>
      <option value="other">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
    </select>
    <div class="other-input" id="otherMaterialLining">
      <input type="text" id="materialLiningOther" placeholder="ç´ æã‚’å…¥åŠ›" oninput="updatePreview()">
    </div>
    
    <label>ã‚«ãƒ©ãƒ¼ <button type="button" class="auto-generate-btn" onclick="generateColorSuggest()">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
    <p style="font-size: 0.75em; color: #888; margin-top: -8px; margin-bottom: 8px;">â€»è‰²ã”ã¨ã«1è¡Œãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    <div class="dynamic-list" id="colorList">
      <div class="dynamic-item color-item">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <input type="text" class="color-input" placeholder="ä¾‹ï¼šãƒ–ãƒ©ãƒƒã‚¯ï¼ˆå†…è£…ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰" oninput="updatePreview()">
      </div>
    </div>
    <button type="button" class="add-btn" onclick="addColorItem()">+ ã‚«ãƒ©ãƒ¼ã‚’è¿½åŠ </button>
    
    <label style="margin-top: 15px;">ç”Ÿç”£åœ°</label>
    <select id="productionPlace" onchange="toggleOtherInput(); updatePreview()">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
      <option value="ä¸­å›½">ä¸­å›½</option>
      <option value="ã‚«ãƒ³ãƒœã‚¸ã‚¢">ã‚«ãƒ³ãƒœã‚¸ã‚¢</option>
      <option value="æ—¥æœ¬">æ—¥æœ¬</option>
      <option value="other">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
    </select>
    <div class="other-input" id="otherProductionPlace">
      <input type="text" id="productionPlaceOther" placeholder="ç”Ÿç”£åœ°ã‚’å…¥åŠ›" oninput="updatePreview()">
    </div>
    
    <label style="margin-top: 15px;">ãã®ä»–ã®é …ç›®</label>
    <p style="font-size: 0.75em; color: #888; margin-top: -8px; margin-bottom: 8px;">â€»è‡ªç”±ã«é …ç›®ã‚’è¿½åŠ ã§ãã¾ã™</p>
    <div class="dynamic-list" id="specOtherList"></div>
    <button type="button" class="add-btn" onclick="addSpecOtherItem()">+ é …ç›®ã‚’è¿½åŠ </button>
    
    <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”»åƒ -->
    <h2>ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”»åƒ</h2>
    <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">â€»ãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯â–²â–¼ãƒœã‚¿ãƒ³ã§ä¸¦ã³æ›¿ãˆå¯èƒ½ / ä¸‹éƒ¨ã«ç™½ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§ä¸€è¦§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <div class="dynamic-list" id="sliderList">
      <div class="dynamic-item" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="drop(event, 'sliderList')" ondragend="dragEnd(event)">
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <div class="image-item-wrapper">
          <div class="move-buttons">
            <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
            <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
          </div>
          <div class="image-thumbnail-placeholder" id="thumb-slider-0">ç”»åƒ<br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
          <div class="image-inputs">
            <label>ç”»åƒURL</label>
            <input type="url" class="slider-img" placeholder="https://cdn.shopify.com/..." oninput="updatePreview(); updateThumbnail(this, 'slider')">
            <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
            <input type="text" class="slider-caption" placeholder="ä¾‹ï¼šå¹…åºƒã„ã‚µã‚¤ã‚ºå±•é–‹" oninput="updatePreview()">
          </div>
        </div>
      </div>
    </div>
    <button type="button" class="add-btn" onclick="addSliderItem()">+ ç”»åƒã‚’è¿½åŠ </button>
    
    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–è¨­å®š -->
    <h2>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ï¼ˆJUDGE.MEï¼‰</h2>
    <p style="font-size: 0.8em; color: #888; margin-bottom: 10px;">â€»æ¨ªã‚¿ãƒ–ã«ã€Œãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚¿ãƒ–ã‚’è¿½åŠ ã—ã¾ã™</p>
    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border: 1px solid #4A90A4;">
      <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 12px;">
        <input type="checkbox" id="enableReviewTab" onchange="updatePreview()" style="width: 18px; height: 18px; margin-right: 10px;">
        <span style="font-weight: bold;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚’è¿½åŠ ã™ã‚‹</span>
      </label>
      <div id="reviewTabOptions" style="display: none; margin-top: 10px;">
        <label>ã‚¿ãƒ–ã®è¡¨ç¤ºå</label>
        <input type="text" id="reviewTabLabel" value="ãƒ¬ãƒ“ãƒ¥ãƒ¼" placeholder="ä¾‹ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãŠå®¢æ§˜ã®å£°" oninput="updatePreview()">
        <p style="font-size: 0.75em; color: #666; margin-top: 8px;">
          â€»JUDGE.MEã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒè‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™<br>
          â€»Shopifyãƒ†ãƒ¼ãƒå´ã§JUDGE.MEãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        </p>
      </div>
    </div>
    
    <!-- å‡ºåŠ›ãƒœã‚¿ãƒ³ -->
    <div class="output-buttons">
      <button type="button" class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ HTMLã‚’ã‚³ãƒ”ãƒ¼</button>
      <button type="button" class="download-btn" onclick="downloadHTML()">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <p class="copy-success" id="copySuccess">âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</p>
  </div>
  
  <!-- å³å´ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ« -->
  <div class="preview-panel">
    <div class="preview-header">
      <span>ğŸ“± ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
      <button class="preview-mode-btn" onclick="togglePreviewMode()">ã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
    </div>
    <iframe id="previewIframe" class="preview-iframe"></iframe>
    <textarea id="codePreview" style="display:none; width:100%; height:calc(100vh - 50px); font-family:monospace; font-size:11px; padding:15px; border:none; background:#1e1e1e; color:#d4d4d4;"></textarea>
  </div>
  
</div>

<script>
let previewMode = 'visual'; // 'visual' or 'code'
let extractedCaptions = []; // æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œ
let extractedColors = []; // æŠ½å‡ºã•ã‚ŒãŸã‚«ãƒ©ãƒ¼å€™è£œ
let extractedSizes = []; // æŠ½å‡ºã•ã‚ŒãŸã‚µã‚¤ã‚ºå€™è£œ

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchLoadTab(tab) {
  // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('loadTabNewPage').style.display = tab === 'newPage' ? 'block' : 'none';
  document.getElementById('loadTabEditHtml').style.display = tab === 'editHtml' ? 'block' : 'none';
  
  // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
  const tabNewPage = document.getElementById('tabNewPage');
  const tabEditHtml = document.getElementById('tabEditHtml');
  
  if (tab === 'newPage') {
    tabNewPage.classList.add('active');
    tabEditHtml.classList.remove('active');
  } else {
    tabNewPage.classList.remove('active');
    tabEditHtml.classList.add('active');
  }
}

// ä½œæˆæ¸ˆã¿HTMLã‚’èª­ã¿è¾¼ã‚“ã§ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
function loadCreatedHTML() {
  try {
    const htmlSource = document.getElementById('editHtmlSource').value;
    if (!htmlSource.trim()) {
      alert('HTMLã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
      return;
    }
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlSource, 'text/html');
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
  resetForm();
  
  // YouTube URL
  const youtubeIframe = doc.querySelector('iframe[src*="youtube"]');
  if (youtubeIframe) {
    document.getElementById('youtubeUrl').value = youtubeIframe.getAttribute('src') || '';
  }
  
  // ã‚¿ã‚¤ãƒˆãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰æŠ½å‡º
  const subtitle = doc.querySelector('.kabag-subtitle');
  const category = doc.querySelector('.kabag-category');
  const productName = doc.querySelector('.kabag-product-name');
  
  if (subtitle) document.getElementById('productSubtitle').value = subtitle.textContent.trim();
  if (category) document.getElementById('productCategory').value = category.textContent.trim();
  if (productName) document.getElementById('productName').value = productName.textContent.trim();
  
  // è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨
  const acc1Content = doc.querySelector('#acc1 ~ .kabag-accordion-content');
  if (acc1Content) {
    const items = acc1Content.querySelectorAll('p');
    const checkboxGroup = document.getElementById('beforePurchaseCheckboxes');
    const customItems = [];
    
    items.forEach(p => {
      const text = p.textContent.replace(/^â˜‘ï¸\s*/, '').trim();
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚ã‚‹é …ç›®ã‹ç¢ºèª
      const checkbox = checkboxGroup.querySelector(`input[value="${text}"]`);
      if (checkbox) {
        checkbox.checked = true;
      } else {
        customItems.push(text);
      }
    });
    
    // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’è¿½åŠ 
    customItems.forEach(text => {
      const list = document.getElementById('beforePurchaseList');
      const item = document.createElement('div');
      item.className = 'dynamic-item';
      item.innerHTML = `
        <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
        <label>é …ç›®</label>
        <input type="text" class="before-purchase-other" value="${text}" oninput="updatePreview()">
      `;
      list.appendChild(item);
    });
  }
  
  // ã‚ˆãã‚ã‚‹è³ªå•
  const acc2Content = doc.querySelector('#acc2 ~ .kabag-accordion-content');
  if (acc2Content) {
    const faqList = document.getElementById('faqList');
    faqList.innerHTML = '';
    
    const faqPs = acc2Content.querySelectorAll('p');
    faqPs.forEach(p => {
      const html = p.innerHTML;
      const qMatch = html.match(/Qï¼š([^<]+)/);
      const aMatch = html.match(/Aï¼š(.+)$/);
      
      if (qMatch && aMatch) {
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        item.innerHTML = `
          <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
          <label>è³ªå•</label>
          <input type="text" class="faq-q" value="${qMatch[1].trim()}" oninput="updatePreview()">
          <label>å›ç­”</label>
          <textarea class="faq-a" oninput="updatePreview()">${aMatch[1].trim()}</textarea>
        `;
        faqList.appendChild(item);
      }
    });
  }
  
  // å•†å“è©³ç´°ç”»åƒ
  const detailSections = doc.querySelectorAll('.kabag-image-section');
  if (detailSections.length > 0) {
    const detailList = document.getElementById('productDetailList');
    detailList.innerHTML = '';
    
    detailSections.forEach((section, index) => {
      const img = section.querySelector('img');
      const captionP = section.querySelector('p:not(.kabag-subtitle):not(.kabag-category):not(.kabag-product-name)');
      const titleBlock = section.querySelector('.kabag-title-block');
      
      if (img) {
        const url = img.getAttribute('src') || '';
        let caption = '';
        
        if (captionP && !titleBlock) {
          caption = captionP.textContent.trim();
        }
        
        addDetailItemWithUrl(url, false);
        const lastItem = detailList.lastElementChild;
        if (lastItem && caption) {
          lastItem.querySelector('.detail-caption').value = caption;
        }
      }
    });
  }
  
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”»åƒ
  const sliderItems = doc.querySelectorAll('.kabag-slider-item');
  if (sliderItems.length > 0) {
    const sliderList = document.getElementById('sliderList');
    sliderList.innerHTML = '';
    
    sliderItems.forEach(item => {
      const img = item.querySelector('img');
      const caption = item.querySelector('.kabag-slider-caption');
      
      if (img) {
        const url = img.getAttribute('src') || '';
        addSliderItemWithUrl(url, false);
        const lastItem = sliderList.lastElementChild;
        if (lastItem && caption) {
          lastItem.querySelector('.slider-caption').value = caption.textContent.trim();
        }
      }
    });
  }
  
  // ã‚µã‚¤ã‚ºãƒ»ç´ æãƒ†ãƒ¼ãƒ–ãƒ«
  const table = doc.querySelector('.tab2-content table');
  if (table) {
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const label = row.querySelector('td:first-child')?.textContent.trim();
      const value = row.querySelector('td:last-child')?.textContent.trim();
      
      if (label && value) {
        switch(label) {
          case 'å®¹é‡':
            document.getElementById('capacity').value = value;
            break;
          case 'é‡ã•':
            document.getElementById('weight').value = value;
            break;
          case 'ã‚µã‚¤ã‚º':
            document.getElementById('size').value = value;
            break;
          case 'ç´ æï¼ˆæœ¬ä½“ï¼‰':
            setMaterialValue('materialMain', 'materialMainOther', value);
            break;
          case 'ç´ æï¼ˆè£åœ°ï¼‰':
            setMaterialValue('materialLining', 'materialLiningOther', value);
            break;
          case 'ã‚«ãƒ©ãƒ¼':
            // ã‚«ãƒ©ãƒ¼ã¯æ”¹è¡Œã§åˆ†å‰²
            const colorList = document.getElementById('colorList');
            colorList.innerHTML = '';
            const colors = value.split(/<br\s*\/?>/i);
            colors.forEach(color => {
              if (color.trim()) {
                const item = document.createElement('div');
                item.className = 'dynamic-item color-item';
                item.innerHTML = `
                  <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
                  <input type="text" class="color-input" value="${color.trim()}" oninput="updatePreview()">
                `;
                colorList.appendChild(item);
              }
            });
            break;
          case 'ç”Ÿç”£åœ°':
            setProductionPlace(value);
            break;
        }
      }
    });
  }
  
  // ä½œæˆæ¸ˆã¿HTMLã‹ã‚‰ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œã‚’æŠ½å‡º
  extractedCaptions = [];
  const allCaptions = doc.querySelectorAll('.kabag-image-section p, .kabag-slider-caption');
  allCaptions.forEach(el => {
    const text = el.textContent.trim();
    if (text && text.length > 5 && !extractedCaptions.includes(text)) {
      extractedCaptions.push(text);
    }
  });
  
  // ã‚«ãƒ©ãƒ¼æƒ…å ±ã‚’æŠ½å‡ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
  extractedColors = [];
  const colorRow = Array.from(doc.querySelectorAll('tr')).find(row => {
    const label = row.querySelector('td:first-child');
    return label && label.textContent.trim() === 'ã‚«ãƒ©ãƒ¼';
  });
  if (colorRow) {
    const colorCell = colorRow.querySelector('td:last-child');
    if (colorCell) {
      const colors = colorCell.innerHTML.split(/<br\s*\/?>/i);
      colors.forEach(c => {
        const cleaned = c.trim();
        if (cleaned && !extractedColors.includes(cleaned)) {
          extractedColors.push(cleaned);
        }
      });
    }
  }
  
  // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’æŠ½å‡º
  extractedSizes = [];
  const sizeRow = Array.from(doc.querySelectorAll('tr')).find(row => {
    const label = row.querySelector('td:first-child');
    return label && label.textContent.trim() === 'ã‚µã‚¤ã‚º';
  });
  if (sizeRow) {
    const sizeCell = sizeRow.querySelector('td:last-child');
    if (sizeCell) {
      const sizeText = sizeCell.textContent.trim();
      if (sizeText) {
        extractedSizes.push(sizeText);
      }
    }
  }
  
  updatePreview();
  alert('HTMLã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\nç·¨é›†å¾Œã€ã€ŒHTMLã‚’ã‚³ãƒ”ãƒ¼ã€ã¾ãŸã¯ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¿å­˜ã§ãã¾ã™ã€‚');
  } catch (e) {
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
    console.error(e);
  }
}

// ç´ æã®å€¤ã‚’ã‚»ãƒƒãƒˆ
function setMaterialValue(selectId, otherId, value) {
  const select = document.getElementById(selectId);
  const otherInput = document.getElementById(otherId);
  const otherDiv = document.getElementById('other' + selectId.charAt(0).toUpperCase() + selectId.slice(1));
  
  // é¸æŠè‚¢ã«ã‚ã‚‹ã‹ç¢ºèª
  let found = false;
  for (let option of select.options) {
    if (option.value === value) {
      select.value = value;
      found = true;
      break;
    }
  }
  
  if (!found && value) {
    select.value = 'other';
    otherInput.value = value;
    if (otherDiv) otherDiv.classList.add('active');
  }
}

// ç”Ÿç”£åœ°ã‚’ã‚»ãƒƒãƒˆ
function setProductionPlace(value) {
  const select = document.getElementById('productionPlace');
  const otherInput = document.getElementById('productionPlaceOther');
  const otherDiv = document.getElementById('otherProductionPlace');
  
  let found = false;
  for (let option of select.options) {
    if (option.value === value) {
      select.value = value;
      found = true;
      break;
    }
  }
  
  if (!found && value) {
    select.value = 'other';
    otherInput.value = value;
    otherDiv.classList.add('active');
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
function resetForm() {
  // åŸºæœ¬æƒ…å ±
  document.getElementById('productSubtitle').value = '';
  document.getElementById('productCategory').value = '';
  document.getElementById('productName').value = '';
  document.getElementById('youtubeUrl').value = '';
  
  // è³¼å…¥å‰ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  document.querySelectorAll('#beforePurchaseCheckboxes input[type="checkbox"]').forEach(cb => {
    cb.checked = cb.value === '30æ—¥é–“è¿”é‡‘ä¿è¨¼â€¼ï¸' || cb.value === 'å…¨å›½é€æ–™ç„¡æ–™â€¼ï¸';
  });
  
  // ãã®ä»–ã®é …ç›®ã‚¯ãƒªã‚¢
  document.getElementById('beforePurchaseList').innerHTML = '<p style="font-size: 0.85em; color: #666; margin: 0 0 8px 0;">ãã®ä»–ã®é …ç›®ï¼š</p>';
  
  // FAQã€å•†å“è©³ç´°ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  document.getElementById('faqList').innerHTML = '';
  document.getElementById('productDetailList').innerHTML = '';
  document.getElementById('sliderList').innerHTML = '';
  document.getElementById('colorList').innerHTML = '';
  
  // ã‚µã‚¤ã‚ºãƒ»ç´ æ
  document.getElementById('capacity').value = '';
  document.getElementById('weight').value = '';
  document.getElementById('size').value = '';
  document.getElementById('materialMain').value = '';
  document.getElementById('materialLining').value = '';
  document.getElementById('productionPlace').value = '';
  
  // ãã®ä»–å…¥åŠ›æ¬„ã‚’éè¡¨ç¤º
  document.querySelectorAll('.other-input').forEach(div => div.classList.remove('active'));
}

// ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³è‡ªå‹•ç”Ÿæˆï¼ˆã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’è¡¨ç¤ºï¼‰
function generateCaption(btn) {
  const inputWrapper = btn.closest('.image-inputs');
  const captionInput = inputWrapper.querySelector('.detail-caption, .slider-caption');
  
  if (extractedCaptions.length === 0) {
    alert('ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nãƒ»æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆï¼šå…ˆã«è§£æã‚’è¡Œã£ã¦ãã ã•ã„\nãƒ»ä½œæˆæ¸ˆã¿HTMLã®å ´åˆï¼šã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // æ—¢å­˜ã®ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
  const existingPopup = document.querySelector('.caption-suggest-popup');
  if (existingPopup) {
    existingPopup.remove();
  }
  
  // ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
  const popup = document.createElement('div');
  popup.className = 'caption-suggest-popup';
  popup.innerHTML = `
    <div class="caption-suggest-header">
      <span>ğŸ“ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰</span>
      <button type="button" onclick="this.closest('.caption-suggest-popup').remove()">âœ•</button>
    </div>
    <div class="caption-suggest-list">
      ${extractedCaptions.map((caption, i) => `
        <div class="caption-suggest-item" onclick="selectCaption(this, '${caption.replace(/'/g, "\\'")}')">
          ${caption}
        </div>
      `).join('')}
    </div>
  `;
  
  inputWrapper.appendChild(popup);
}

// ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦å…¥åŠ›æ¬„ã«åæ˜ 
function selectCaption(item, caption) {
  const popup = item.closest('.caption-suggest-popup');
  const inputWrapper = popup.closest('.image-inputs');
  const captionInput = inputWrapper.querySelector('.detail-caption, .slider-caption');
  
  captionInput.value = caption;
  
  // é¸æŠæ¸ˆã¿ã«ã™ã‚‹
  item.classList.add('selected');
  
  popup.remove();
  updatePreview();
}

// é …ç›®è¿½åŠ é–¢æ•°
function addBeforePurchaseItem() {
  const list = document.getElementById('beforePurchaseList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <label>é …ç›®</label>
    <input type="text" class="before-purchase-other" placeholder="ä¾‹ï¼šæŠ˜ã‚ŠãŸãŸã¿å‚˜åç´OK" oninput="updatePreview()">
  `;
  list.appendChild(item);
  updatePreview();
}

function addFaqItem() {
  const list = document.getElementById('faqList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <label>è³ªå•</label>
    <input type="text" class="faq-q" placeholder="è³ªå•ã‚’å…¥åŠ›" oninput="updatePreview()">
    <label>å›ç­”</label>
    <textarea class="faq-a" placeholder="å›ç­”ã‚’å…¥åŠ›" oninput="updatePreview()"></textarea>
  `;
  list.appendChild(item);
  updatePreview();
}

function addDetailItem() {
  const list = document.getElementById('productDetailList');
  const index = list.children.length;
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.draggable = true;
  item.ondragstart = dragStart;
  item.ondragover = dragOver;
  item.ondrop = function(e) { drop(e, 'productDetailList'); };
  item.ondragend = dragEnd;
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <div class="image-item-wrapper">
      <div class="move-buttons">
        <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
        <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
      </div>
      <div class="image-thumbnail-placeholder">ç”»åƒ<br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div class="image-inputs">
        <label>ç”»åƒURL</label>
        <input type="url" class="detail-img" placeholder="https://cdn.shopify.com/..." oninput="updatePreview(); updateThumbnail(this, 'detail')">
        <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
        <textarea class="detail-caption" placeholder="ä¾‹ï¼šã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«ç´ æã‚’æ„Ÿã˜ã¦ã‚‚ã‚‰ãˆã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€‚" oninput="updatePreview()"></textarea>
      </div>
    </div>
  `;
  list.appendChild(item);
  updatePreview();
}

function addSliderItem() {
  const list = document.getElementById('sliderList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.draggable = true;
  item.ondragstart = dragStart;
  item.ondragover = dragOver;
  item.ondrop = function(e) { drop(e, 'sliderList'); };
  item.ondragend = dragEnd;
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <div class="image-item-wrapper">
      <div class="move-buttons">
        <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
        <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
      </div>
      <div class="image-thumbnail-placeholder">ç”»åƒ<br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div class="image-inputs">
        <label>ç”»åƒURL</label>
        <input type="url" class="slider-img" placeholder="https://cdn.shopify.com/..." oninput="updatePreview(); updateThumbnail(this, 'slider')">
        <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
        <input type="text" class="slider-caption" placeholder="ä¾‹ï¼šå¹…åºƒã„ã‚µã‚¤ã‚ºå±•é–‹" oninput="updatePreview()">
      </div>
    </div>
  `;
  list.appendChild(item);
  updatePreview();
}

function deleteItem(btn) {
  const item = btn.closest('.dynamic-item');
  if (item) {
    // ç”»åƒURLã‚’å–å¾—ï¼ˆå•†å“è©³ç´°ã¾ãŸã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å ´åˆï¼‰
    const imgInput = item.querySelector('.detail-img, .slider-img');
    if (imgInput && imgInput.value) {
      const deletedUrl = imgInput.value;
      // æŠ½å‡ºã•ã‚ŒãŸç”»åƒã‹ã‚‰ã€Œè¿½åŠ æ¸ˆã¿ã€ã‚’è§£é™¤
      releaseImageFromUsed(deletedUrl);
    }
    
    item.remove();
    updatePreview();
  }
}

// æŠ½å‡ºã•ã‚ŒãŸç”»åƒã®ã€Œè¿½åŠ æ¸ˆã¿ã€çŠ¶æ…‹ã‚’è§£é™¤
function releaseImageFromUsed(url) {
  const imageGrid = document.getElementById('imageGrid');
  if (!imageGrid) return;
  
  const gridItems = imageGrid.querySelectorAll('.image-grid-item');
  gridItems.forEach(item => {
    const itemUrl = item.getAttribute('data-url');
    // URLã®åŸºæœ¬éƒ¨åˆ†ã§æ¯”è¼ƒï¼ˆã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™¤ãï¼‰
    const baseUrl1 = url.split('?')[0];
    const baseUrl2 = itemUrl ? itemUrl.split('?')[0] : '';
    
    if (baseUrl1 === baseUrl2) {
      item.classList.remove('used');
    }
  });
}

function toggleOtherInput() {
  const select = document.getElementById('productionPlace');
  const otherDiv = document.getElementById('otherProductionPlace');
  if (select.value === 'other') {
    otherDiv.classList.add('active');
  } else {
    otherDiv.classList.remove('active');
  }
}

// ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
document.addEventListener('DOMContentLoaded', function() {
  const reviewCheckbox = document.getElementById('enableReviewTab');
  const reviewOptions = document.getElementById('reviewTabOptions');
  
  reviewCheckbox.addEventListener('change', function() {
    reviewOptions.style.display = this.checked ? 'block' : 'none';
  });
});

// ç´ æã®ã€Œãã®ä»–ã€å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆ
function toggleMaterialOther(type) {
  const select = document.getElementById('material' + type);
  const otherDiv = document.getElementById('otherMaterial' + type);
  if (select.value === 'other') {
    otherDiv.classList.add('active');
  } else {
    otherDiv.classList.remove('active');
  }
}

// ã‚«ãƒ©ãƒ¼è¿½åŠ 
function addColorItem() {
  const list = document.getElementById('colorList');
  const item = document.createElement('div');
  item.className = 'dynamic-item color-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <input type="text" class="color-input" placeholder="ä¾‹ï¼šãƒã‚¤ãƒ“ãƒ¼ï¼ˆå†…è£…ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ï¼‰" oninput="updatePreview()">
  `;
  list.appendChild(item);
  updatePreview();
}

// ã‚µã‚¤ã‚ºãƒ»ç´ æã®ãã®ä»–é …ç›®ã‚’è¿½åŠ 
function addSpecOtherItem() {
  const list = document.getElementById('specOtherList');
  const item = document.createElement('div');
  item.className = 'dynamic-item spec-other-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <div class="spec-other-inputs">
      <input type="text" class="spec-other-label" placeholder="é …ç›®åï¼ˆä¾‹ï¼šãƒã‚±ãƒƒãƒˆæ•°ï¼‰" oninput="updatePreview()">
      <input type="text" class="spec-other-value" placeholder="å€¤ï¼ˆä¾‹ï¼š5ã¤ï¼‰" oninput="updatePreview()">
    </div>
  `;
  list.appendChild(item);
  updatePreview();
}

// ã‚«ãƒ©ãƒ¼ã‚µã‚¸ã‚§ã‚¹ãƒˆ
function generateColorSuggest() {
  if (extractedColors.length === 0) {
    alert('ã‚«ãƒ©ãƒ¼å€™è£œãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nãƒ»æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆï¼šå…ˆã«è§£æã‚’è¡Œã£ã¦ãã ã•ã„\nãƒ»ä½œæˆæ¸ˆã¿HTMLã®å ´åˆï¼šã‚«ãƒ©ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
  const existingPopup = document.querySelector('.color-suggest-popup');
  if (existingPopup) existingPopup.remove();
  
  const colorList = document.getElementById('colorList');
  const popup = document.createElement('div');
  popup.className = 'caption-suggest-popup color-suggest-popup';
  popup.innerHTML = `
    <div class="caption-suggest-header">
      <span>ğŸ¨ ã‚«ãƒ©ãƒ¼å€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</span>
      <button type="button" onclick="this.closest('.color-suggest-popup').remove()">âœ•</button>
    </div>
    <div class="caption-suggest-list">
      ${extractedColors.map((color, i) => `
        <div class="caption-suggest-item" onclick="addColorFromSuggest('${color.replace(/'/g, "\\'")}')">
          ${color}
        </div>
      `).join('')}
    </div>
  `;
  colorList.parentElement.insertBefore(popup, colorList.nextSibling);
}

function addColorFromSuggest(color) {
  const list = document.getElementById('colorList');
  const item = document.createElement('div');
  item.className = 'dynamic-item color-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <input type="text" class="color-input" value="${color}" oninput="updatePreview()">
  `;
  list.appendChild(item);
  updatePreview();
}

// ã‚µã‚¤ã‚ºã‚µã‚¸ã‚§ã‚¹ãƒˆ
function generateSizeSuggest() {
  if (extractedSizes.length === 0) {
    alert('ã‚µã‚¤ã‚ºå€™è£œãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nãƒ»æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€å ´åˆï¼šå…ˆã«è§£æã‚’è¡Œã£ã¦ãã ã•ã„\nãƒ»ä½œæˆæ¸ˆã¿HTMLã®å ´åˆï¼šã‚µã‚¤ã‚ºæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const sizeInput = document.getElementById('size');
  const existingPopup = document.querySelector('.size-suggest-popup');
  if (existingPopup) existingPopup.remove();
  
  const popup = document.createElement('div');
  popup.className = 'caption-suggest-popup size-suggest-popup';
  popup.style.position = 'absolute';
  popup.style.width = '100%';
  popup.innerHTML = `
    <div class="caption-suggest-header">
      <span>ğŸ“ ã‚µã‚¤ã‚ºå€™è£œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼‰</span>
      <button type="button" onclick="this.closest('.size-suggest-popup').remove()">âœ•</button>
    </div>
    <div class="caption-suggest-list">
      ${extractedSizes.map((size, i) => `
        <div class="caption-suggest-item" onclick="selectSize('${size.replace(/'/g, "\\'")}')">
          ${size}
        </div>
      `).join('')}
    </div>
  `;
  sizeInput.parentElement.style.position = 'relative';
  sizeInput.parentElement.appendChild(popup);
}

function selectSize(size) {
  document.getElementById('size').value = size;
  const popup = document.querySelector('.size-suggest-popup');
  if (popup) popup.remove();
  updatePreview();
}

function togglePreviewMode() {
  const iframe = document.getElementById('previewIframe');
  const codeArea = document.getElementById('codePreview');
  const btn = document.querySelector('.preview-mode-btn');
  
  if (previewMode === 'visual') {
    previewMode = 'code';
    iframe.style.display = 'none';
    codeArea.style.display = 'block';
    btn.textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º';
    codeArea.value = generateHTMLCode();
  } else {
    previewMode = 'visual';
    iframe.style.display = 'block';
    codeArea.style.display = 'none';
    btn.textContent = 'ã‚³ãƒ¼ãƒ‰è¡¨ç¤º';
  }
}

// HTMLç”Ÿæˆ
function generateHTMLCode() {
  const productSubtitle = document.getElementById('productSubtitle').value || '';
  const productCategory = document.getElementById('productCategory').value || '';
  const productName = document.getElementById('productName').value || 'å•†å“å';
  const youtubeUrl = document.getElementById('youtubeUrl').value;
  
  // è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨
  const checkboxes = document.querySelectorAll('#beforePurchaseCheckboxes input[type="checkbox"]:checked');
  let beforePurchaseItems = Array.from(checkboxes).map(cb => cb.value);
  const otherItems = document.querySelectorAll('.before-purchase-other');
  otherItems.forEach(item => {
    if (item.value.trim()) {
      beforePurchaseItems.push(item.value.trim());
    }
  });
  
  // ã‚ˆãã‚ã‚‹è³ªå•
  const faqItems = [];
  document.querySelectorAll('#faqList .dynamic-item').forEach(item => {
    const q = item.querySelector('.faq-q').value;
    const a = item.querySelector('.faq-a').value;
    if (q && a) {
      faqItems.push({ q, a });
    }
  });
  
  // å•†å“è©³ç´°
  const detailItems = [];
  document.querySelectorAll('#productDetailList .dynamic-item').forEach(item => {
    const img = item.querySelector('.detail-img').value;
    const captionEl = item.querySelector('.detail-caption');
    const caption = captionEl ? captionEl.value : '';
    if (img) {
      detailItems.push({ img, caption });
    }
  });
  
  // ã‚µã‚¤ã‚ºãƒ»ç´ æ
  const capacity = document.getElementById('capacity').value;
  const weight = document.getElementById('weight').value;
  const size = document.getElementById('size').value;
  
  // ç´ æï¼ˆã€Œãã®ä»–ã€å¯¾å¿œï¼‰
  const materialMainSelect = document.getElementById('materialMain').value;
  const materialMain = materialMainSelect === 'other' 
    ? document.getElementById('materialMainOther').value 
    : materialMainSelect;
  
  const materialLiningSelect = document.getElementById('materialLining').value;
  const materialLining = materialLiningSelect === 'other' 
    ? document.getElementById('materialLiningOther').value 
    : materialLiningSelect;
  
  // ã‚«ãƒ©ãƒ¼ï¼ˆè¤‡æ•°è¡Œï¼‰
  const colorItems = [];
  document.querySelectorAll('#colorList .color-input').forEach(input => {
    if (input.value.trim()) {
      colorItems.push(input.value.trim());
    }
  });
  
  const productionPlaceSelect = document.getElementById('productionPlace').value;
  const productionPlace = productionPlaceSelect === 'other' 
    ? document.getElementById('productionPlaceOther').value 
    : productionPlaceSelect;
  
  // ãã®ä»–ã®é …ç›®ï¼ˆã‚µã‚¤ã‚ºãƒ»ç´ æï¼‰
  const specOtherItems = [];
  document.querySelectorAll('#specOtherList .spec-other-item').forEach(item => {
    const label = item.querySelector('.spec-other-label').value.trim();
    const value = item.querySelector('.spec-other-value').value.trim();
    if (label && value) {
      specOtherItems.push({ label, value });
    }
  });
  
  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  const sliderItems = [];
  document.querySelectorAll('#sliderList .dynamic-item').forEach(item => {
    const img = item.querySelector('.slider-img').value;
    const captionEl = item.querySelector('.slider-caption');
    const caption = captionEl ? captionEl.value : '';
    if (img) {
      sliderItems.push({ img, caption });
    }
  });
  
  // HTMLç”Ÿæˆ
  let html = `<!-- ============================================
     ${productName} å•†å“ãƒšãƒ¼ã‚¸
     CSSã®ã¿ã§ã‚¿ãƒ–/ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’å®Ÿç¾
     ï¼ˆJavaScriptä¸è¦ãƒ»Shopifyå•†å“èª¬æ˜æ¬„ç”¨ï¼‰
     ============================================ -->

<style>
/* ========== ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰========== */
.kabag-accordion {
  border: 1px solid #e0e0e0;
  margin-bottom: -1px;
}
.kabag-accordion input[type="checkbox"] {
  display: none;
}
.kabag-accordion-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: #fff;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  color: #333;
}
.kabag-accordion-label:hover {
  background: #f9f9f9;
}
.kabag-accordion-label::after {
  content: "â–¼";
  font-size: 12px;
  transition: transform 0.3s;
}
.kabag-accordion input[type="checkbox"]:checked + .kabag-accordion-label::after {
  transform: rotate(180deg);
}
.kabag-accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
  background: #fafafa;
  font-size: 14px;
  line-height: 1.8;
  color: #555;
}
.kabag-accordion input[type="checkbox"]:checked ~ .kabag-accordion-content {
  max-height: 1000px;
  padding: 20px;
  border-top: 1px solid #e0e0e0;
}

/* ========== æ¨ªã‚¿ãƒ– ========== */
.kabag-tabs-wrapper {
  margin-top: 30px;
}
.kabag-tabs-wrapper input[type="radio"] {
  display: none;
}
.kabag-tabs-nav {
  display: flex !important;
  flex-direction: row !important;
  flex-wrap: nowrap !important;
  align-items: stretch !important;
  justify-content: stretch !important;
  border-bottom: 2px solid #e0e0e0;
  width: 100%;
  margin: 0 !important;
  padding: 0 !important;
}
.kabag-tabs-nav label {
  flex: 1 1 0 !important;
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: center !important;
  text-align: center !important;
  padding: 14px 8px !important;
  margin: 0 !important;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  color: #888;
  border: none !important;
  border-bottom: 2px solid transparent !important;
  margin-bottom: -2px !important;
  transition: all 0.3s;
  min-height: 50px !important;
  max-height: none !important;
  height: auto !important;
  box-sizing: border-box !important;
  vertical-align: middle !important;
  line-height: 1.3 !important;
  float: none !important;
  position: relative !important;
  top: 0 !important;
  bottom: 0 !important;
  background: transparent !important;
}
.kabag-tabs-nav label:hover {
  color: #333;
}
#kabag-tab1:checked ~ .kabag-tabs-nav label[for="kabag-tab1"],
#kabag-tab2:checked ~ .kabag-tabs-nav label[for="kabag-tab2"],
#kabag-tab3:checked ~ .kabag-tabs-nav label[for="kabag-tab3"] {
  color: #333;
  border-bottom: 2px solid #F6A800 !important;
}
.kabag-tab-content {
  display: none;
  padding: 30px 0;
}
#kabag-tab1:checked ~ .kabag-tab-content.tab1-content,
#kabag-tab2:checked ~ .kabag-tab-content.tab2-content,
#kabag-tab3:checked ~ .kabag-tab-content.tab3-content {
  display: block;
}

/* ========== ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
.kabag-image-section {
  text-align: center;
  margin-bottom: 40px;
}
.kabag-image-section img {
  max-width: 100%;
}
.kabag-image-section p {
  font-size: 1.1em;
  margin-top: 16px;
  color: #333;
}

/* ========== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰ ========== */
.kabag-slider {
  margin-top: 40px;
  position: relative;
}
.kabag-slider-title {
  text-align: center;
  font-size: 1.2em;
  font-weight: bold;
  margin-bottom: 20px;
  color: #333;
}
.kabag-slider-wrapper {
  position: relative;
}
.kabag-slider-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 2em;
  font-weight: bold;
  color: #333;
  z-index: 10;
  pointer-events: none;
  opacity: 0.7;
  text-shadow: 0 0 8px rgba(255,255,255,0.8);
}
.kabag-slider-arrow-left {
  left: 10px;
}
.kabag-slider-arrow-right {
  right: 10px;
}
.kabag-slider-container {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  gap: 10px;
  padding: 0;
}
.kabag-slider-container::-webkit-scrollbar {
  display: none;
}
.kabag-slider-item {
  flex: 0 0 100%;
  scroll-snap-align: start;
  border-radius: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
.kabag-slider-item img {
  width: 100%;
  aspect-ratio: 16 / 9;
  object-fit: contain;
  object-position: center center;
  display: block;
  background: #fff;
}
.kabag-slider-caption {
  text-align: center;
  padding: 12px 10px;
  font-size: 0.95em;
  color: #333;
  background: #fff;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç”¨ã‚¿ã‚¤ãƒˆãƒ« ========== */
.kabag-main-visual {
  margin-bottom: 50px;
}
.kabag-title-block {
  margin-top: 20px;
}
.kabag-subtitle {
  font-size: 0.9em;
  color: #666;
  margin: 0 0 8px 0;
}
.kabag-category {
  font-size: 1.3em;
  font-weight: bold;
  color: #333;
  margin: 0 0 4px 0;
}
.kabag-product-name {
  font-size: 1.8em;
  font-weight: bold;
  color: #333;
  margin: 0;
}
</style>

`;

  // YouTubeå‹•ç”»
  if (youtubeUrl) {
    html += `
<!-- =============================================
     â–¼â–¼â–¼ YouTubeå‹•ç”»ï¼ˆã‚¿ãƒ–ã®å¤–ãƒ»ä¸€ç•ªä¸Šï¼‰ â–¼â–¼â–¼
     ============================================= -->

<div style="text-align: center; margin: 20px 0 40px 0;">
  <div style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden;">
    <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="${youtubeUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
  </div>
</div>

`;
  }

  // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
  html += `
<!-- =============================================
     â–¼â–¼â–¼ ä¸Šæ®µï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³3ã¤ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ â–¼â–¼â–¼
     ============================================= -->

<!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³1ï¼šè³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨ -->
<div class="kabag-accordion">
  <input type="checkbox" id="acc1">
  <label class="kabag-accordion-label" for="acc1">è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨</label>
  <div class="kabag-accordion-content">
`;
  
  beforePurchaseItems.forEach(item => {
    html += `    <p>â˜‘ï¸ ${item}</p>\n`;
  });
  
  html += `  </div>
</div>

<!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³2ï¼šã‚ˆãã‚ã‚‹è³ªå• -->
<div class="kabag-accordion">
  <input type="checkbox" id="acc2">
  <label class="kabag-accordion-label" for="acc2">ã‚ˆãã‚ã‚‹è³ªå•</label>
  <div class="kabag-accordion-content">
`;
  
  faqItems.forEach((faq, index) => {
    const marginTop = index > 0 ? ' style="margin-top: 16px;"' : '';
    html += `    <p${marginTop}><strong>Qï¼š${faq.q}</strong><br>\n    Aï¼š${faq.a}</p>\n`;
  });
  
  html += `  </div>
</div>

<!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³3ï¼š30æ—¥é–“è¿”é‡‘ä¿è¨¼ã«ã¤ã„ã¦ -->
<div class="kabag-accordion">
  <input type="checkbox" id="acc3">
  <label class="kabag-accordion-label" for="acc3">30æ—¥é–“è¿”é‡‘ä¿è¨¼ã«ã¤ã„ã¦</label>
  <div class="kabag-accordion-content">
    <p><strong>30æ—¥é–“è¿”é‡‘ä¿è¨¼ã®å¯¾è±¡ã¯ã€Œå±‹å†…è©¦ç”¨ã®ã¿ã€ã¨ãªã‚Šã¾ã™ã€‚</strong><br>
    è¿”é‡‘ã‚’ã”å¸Œæœ›ã®éš›ã¯ã€å•†å“åˆ°ç€å¾Œ30æ—¥ä»¥å†…ã«ã€è¿”é‡‘å¸Œæœ›ç”¨ç´™ã€‘ã‚’åŒæ¢±ã—ã€ç€æ‰•ã„ã«ã¦ã”è¿”é€ãã ã•ã„ã€‚</p>
    
    <div style="background: #f0f8f0; padding: 12px; border-radius: 6px; margin: 16px 0;">
      <p style="margin: 0 0 8px 0; color: #2e7d32;"><strong>âœ“ OKï¼ˆè¿”å“å¯¾è±¡ï¼‰</strong></p>
      <p style="margin: 0; font-size: 0.95em;">
        ãƒ»å®¤å†…ã§ã®åç´ãƒ†ã‚¹ãƒˆãƒ»ãƒãƒ¼ãƒç¢ºèª<br>
        ãƒ»é¡ã®å‰ã§ã®èƒŒè² ã„å¿ƒåœ°ãƒã‚§ãƒƒã‚¯<br>
        ãƒ»åºŠç½®ãã™ã‚‹å ´åˆã¯ã€ã‚·ãƒ¼ãƒˆç­‰ã‚’æ•·ã„ãŸã†ãˆã§çŸ­æ™‚é–“ã®ç¢ºèª
      </p>
    </div>
    
    <div style="background: #fef0f0; padding: 12px; border-radius: 6px; margin: 16px 0;">
      <p style="margin: 0 0 8px 0; color: #c62828;"><strong>âœ— NGï¼ˆè¿”é‡‘å¯¾è±¡å¤–ã¾ãŸã¯æ¸›é¡ï¼‰</strong></p>
      <p style="margin: 0; font-size: 0.95em;">
        ãƒ»å±‹å¤–ã§ã®æŒã¡å‡ºã—ãƒ»ä½¿ç”¨ï¼ˆé€šå‹¤ãƒ»é€šå­¦ãƒ»è²·ã„ç‰©ãƒ»æ—…è¡Œãƒ»æ’®å½±ãªã©ï¼‰<br>
        ãƒ»é›¨ãƒ»é›ªãƒ»æ°´æ¿¡ã‚Œã€è¡£é¡ã‚„ä»–è£½å“ã‹ã‚‰ã®è‰²ç§»ã‚Šã€åœ§è¿«ã«ã‚ˆã‚‹å¤‰å½¢<br>
        ãƒ»é¦™æ°´ãƒ»ãŠé¦™ãƒ»ã‚¿ãƒã‚³ç­‰ã®ã«ãŠã„ã®ä»˜ç€<br>
        ãƒ»ä»˜å±å“ï¼ˆç®±ãƒ»ã‚¿ã‚°ãƒ»èª¬æ˜æ›¸ï¼‰ã®æ¬ å“ãƒ»ç ´æ
      </p>
    </div>
    
    <p style="margin-top: 16px; font-size: 0.95em;">
      <strong>Q. ç„é–¢å…ˆã‚„ãƒ™ãƒ©ãƒ³ãƒ€ã§èƒŒè² ã„å¿ƒåœ°ã‚’ç¢ºèªã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ</strong><br>
      A. å±‹å†…ã®ç¯„å›²ã§ã€çŸ­æ™‚é–“ã§ã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
    </p>
    <p style="font-size: 0.95em;">
      <strong>Q. ã‚¿ã‚°ã‚’ä¸€åº¦å¤–ã—ã¦ã—ã¾ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ</strong><br>
      A. å•†å“ã®ä¾¡å€¤ã‚’å¤§ããæãªã‚ãªã„ç¯„å›²ã§ã‚ã‚Œã°åŸå‰‡ã¨ã—ã¦å—ã‘ä»˜ã‘ã¾ã™ã€‚ãŸã ã—ã€ã‚¿ã‚°ã¯ä¿ç®¡ã—ã€è¿”å“æ™‚ã«å¿…ãšåŒæ¢±ã—ã¦ãã ã•ã„ã€‚
    </p>
  </div>
</div>

`;

  // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ã®è¨­å®šã‚’å–å¾—
  const enableReviewTab = document.getElementById('enableReviewTab').checked;
  const reviewTabLabel = document.getElementById('reviewTabLabel').value || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼';

  // ã‚¿ãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  html += `
<!-- =============================================
     â–¼â–¼â–¼ ä¸‹æ®µï¼šæ¨ªã‚¿ãƒ–ï¼ˆå•†å“è©³ç´°ï¼ã‚µã‚¤ã‚ºãƒ»ç´ æ${enableReviewTab ? 'ï¼ãƒ¬ãƒ“ãƒ¥ãƒ¼' : ''}ï¼‰ â–¼â–¼â–¼
     ============================================= -->

<div class="kabag-tabs-wrapper">
  <input type="radio" name="kabag-tabs" id="kabag-tab1" checked>
  <input type="radio" name="kabag-tabs" id="kabag-tab2">
${enableReviewTab ? '  <input type="radio" name="kabag-tabs" id="kabag-tab3">' : ''}
  
  <div class="kabag-tabs-nav">
    <label for="kabag-tab1">å•†å“è©³ç´°</label>
    <label for="kabag-tab2">ã‚µã‚¤ã‚ºãƒ»ç´ æ</label>
${enableReviewTab ? `    <label for="kabag-tab3">${reviewTabLabel}</label>` : ''}
  </div>
  
  <!-- ã‚¿ãƒ–1ï¼šå•†å“è©³ç´° -->
  <div class="kabag-tab-content tab1-content">
`;
  
  detailItems.forEach((detail, index) => {
    if (index === 0) {
      // æœ€ä¸Šæ®µï¼šãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆ3æ®µæ§‹æˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
      html += `
    <div class="kabag-image-section kabag-main-visual">
      <img src="${detail.img}" alt="ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«">
      <div class="kabag-title-block">
        ${productSubtitle ? `<p class="kabag-subtitle">${productSubtitle}</p>` : ''}
        ${productCategory ? `<p class="kabag-category">${productCategory}</p>` : ''}
        <p class="kabag-product-name">${productName}</p>
      </div>
    </div>
`;
    } else {
      // 2ç•ªç›®ä»¥é™ï¼šé€šå¸¸ã®ç”»åƒï¼‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
      html += `
    <div class="kabag-image-section">
      <img src="${detail.img}" alt="å•†å“ç”»åƒ${index + 1}">
      ${detail.caption ? `<p>${detail.caption}</p>` : ''}
    </div>
`;
    }
  });

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆå•†å“è©³ç´°ã‚¿ãƒ–å†…ï¼‰- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‹ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œ
  if (sliderItems.length > 0) {
    html += `
    <!-- å•†å“ä»•æ§˜ã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
    <div class="kabag-slider">
      <p class="kabag-slider-title">å•†å“ä»•æ§˜ã‚®ãƒ£ãƒ©ãƒªãƒ¼</p>
      <div class="kabag-slider-wrapper">
        <span class="kabag-slider-arrow kabag-slider-arrow-left">ï¼œ</span>
        <span class="kabag-slider-arrow kabag-slider-arrow-right">ï¼</span>
        <div class="kabag-slider-container">
          <!-- ãƒ€ãƒŸãƒ¼è¦ç´ ï¼ˆéè¡¨ç¤ºï¼‰ -->
          <div class="kabag-slider-item" style="display: none;"></div>
`;
    
    sliderItems.forEach((item, index) => {
      html += `          <div class="kabag-slider-item" id="slide-${index}">
            <img src="${item.img}" alt="å•†å“ç”»åƒ${index + 1}">
            ${item.caption ? `<p class="kabag-slider-caption">${item.caption}</p>` : ''}
          </div>\n`;
    });
    
    html += `        </div>
      </div>
    </div>
`;
  }
  
  html += `    
  </div>
  
  <!-- ã‚¿ãƒ–2ï¼šã‚µã‚¤ã‚ºãƒ»ç´ æ -->
  <div class="kabag-tab-content tab2-content">
    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px;">
`;
  
  if (capacity) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; width: 35%; color: #888;">å®¹é‡</td>
        <td style="padding: 12px 0;">${capacity}</td>
      </tr>\n`;
  }
  if (weight) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">é‡ã•</td>
        <td style="padding: 12px 0;">${weight}</td>
      </tr>\n`;
  }
  if (size) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">ã‚µã‚¤ã‚º</td>
        <td style="padding: 12px 0;">${size}</td>
      </tr>\n`;
  }
  if (materialMain) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">ç´ æï¼ˆæœ¬ä½“ï¼‰</td>
        <td style="padding: 12px 0;">${materialMain}</td>
      </tr>\n`;
  }
  if (materialLining) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">ç´ æï¼ˆè£åœ°ï¼‰</td>
        <td style="padding: 12px 0;">${materialLining}</td>
      </tr>\n`;
  }
  if (colorItems.length > 0) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; width: 35%; color: #888; vertical-align: top;">ã‚«ãƒ©ãƒ¼</td>
        <td style="padding: 12px 0;">${colorItems.join('<br>')}</td>
      </tr>\n`;
  }
  if (productionPlace) {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">ç”Ÿç”£åœ°</td>
        <td style="padding: 12px 0;">${productionPlace}</td>
      </tr>\n`;
  }
  
  // ãã®ä»–ã®é …ç›®ã‚’å‡ºåŠ›
  specOtherItems.forEach(item => {
    html += `      <tr style="border-bottom: 1px solid #e0e0e0;">
        <td style="padding: 12px 0; color: #888;">${item.label}</td>
        <td style="padding: 12px 0;">${item.value}</td>
      </tr>\n`;
  });
  
  html += `    </table>
    
    <p style="font-size: 0.9em; color: #888;">
      ã€æ³¨æ„äº‹é …ã€‘<br>
      ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒ¼ç’°å¢ƒã«ã‚ˆã‚Šã€å®Ÿéš›ã®è‰²å‘³ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
      ãƒ»å…‰ã®å½“ãŸã‚Šå…·åˆã«ã‚ˆã£ã¦ã‚‚ã€è‰²å‘³ãŒé•ã£ã¦è¦‹ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    </p>
  </div>
`;

  // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ–ï¼ˆæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
  if (enableReviewTab) {
    html += `
  <!-- ã‚¿ãƒ–3ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="kabag-tab-content tab3-content">
    <div class="jdgm-widget jdgm-review-widget"></div>
  </div>
`;
  }

  html += `  
</div>
`;

  return html;
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
function updatePreview() {
  const html = generateHTMLCode();
  const iframe = document.getElementById('previewIframe');
  const codeArea = document.getElementById('codePreview');
  
  // iframeã«HTMLã‚’æ›¸ãè¾¼ã‚€
  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
  iframeDoc.open();
  iframeDoc.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; margin: 0; }
      </style>
    </head>
    <body>
      ${html}
    </body>
    </html>
  `);
  iframeDoc.close();
  
  // ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚‚æ›´æ–°
  if (previewMode === 'code') {
    codeArea.value = html;
  }
}

function copyToClipboard() {
  const html = generateHTMLCode();
  navigator.clipboard.writeText(html).then(() => {
    const successMsg = document.getElementById('copySuccess');
    successMsg.style.display = 'block';
    setTimeout(() => {
      successMsg.style.display = 'none';
    }, 2000);
  });
}

function downloadHTML() {
  const content = generateHTMLCode();
  const productName = document.getElementById('productName').value || 'kabag_product';
  const blob = new Blob([content], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${productName.replace(/\s+/g, '_')}.html`;
  a.click();
  URL.revokeObjectURL(url);
}

// åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
window.onload = function() {
  updatePreview();
};

// YouTubeåŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‹ã‚‰URLã‚’æŠ½å‡º
function extractYoutubeUrl(input) {
  let value = input.value.trim();
  
  // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼ˆ<iframe...>ï¼‰ãŒè²¼ã‚Šä»˜ã‘ã‚‰ã‚ŒãŸå ´åˆ
  if (value.includes('<iframe') || value.includes('&lt;iframe')) {
    // srcå±æ€§ã‹ã‚‰URLã‚’æŠ½å‡º
    const srcMatch = value.match(/src=["']([^"']+)["']/);
    if (srcMatch && srcMatch[1]) {
      let url = srcMatch[1];
      // HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
      url = url.replace(/&amp;/g, '&');
      input.value = url;
    }
  }
  // é€šå¸¸ã®YouTube URLï¼ˆwatch?v=å½¢å¼ï¼‰ãŒè²¼ã‚Šä»˜ã‘ã‚‰ã‚ŒãŸå ´åˆ
  else if (value.includes('youtube.com/watch') || value.includes('youtu.be/')) {
    let videoId = '';
    
    if (value.includes('youtube.com/watch')) {
      const urlParams = new URLSearchParams(value.split('?')[1]);
      videoId = urlParams.get('v');
    } else if (value.includes('youtu.be/')) {
      videoId = value.split('youtu.be/')[1].split('?')[0].split('&')[0];
    }
    
    if (videoId) {
      input.value = 'https://www.youtube.com/embed/' + videoId;
    }
  }
}

// HTMLã‚½ãƒ¼ã‚¹è§£æ
function parseHTMLSource() {
  const source = document.getElementById('htmlSource').value;
  if (!source.trim()) {
    alert('HTMLã‚½ãƒ¼ã‚¹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    return;
  }
  
  const parser = new DOMParser();
  const doc = parser.parseFromString(source, 'text/html');
  
  // å•†å“åã‚’æŠ½å‡º
  const title = doc.querySelector('h1')?.textContent || doc.querySelector('title')?.textContent || '';
  if (title) {
    document.getElementById('productName').value = title.trim().replace(/\s+/g, ' ');
  }
  
  // YouTubeå‹•ç”»ã‚’æŠ½å‡º
  const youtubeIframe = doc.querySelector('iframe[src*="youtube.com"], iframe[src*="youtu.be"]');
  if (youtubeIframe) {
    const src = youtubeIframe.getAttribute('src');
    if (src) {
      document.getElementById('youtubeUrl').value = src;
    }
  }
  
  // ç”»åƒã‚’æŠ½å‡ºï¼ˆShopify CDNã®ç”»åƒã®ã¿ï¼‰
  const images = doc.querySelectorAll('img[src*="cdn.shopify.com"]');
  const imageUrls = [];
  const seenUrls = new Set();
  
  images.forEach(img => {
    let src = img.getAttribute('src') || '';
    // ç›¸å¯¾URLã‚’çµ¶å¯¾URLã«å¤‰æ›
    if (src.startsWith('//')) {
      src = 'https:' + src;
    }
    // å°ã•ã„ã‚µãƒ ãƒã‚¤ãƒ«ã¯é™¤å¤–
    if (src.includes('_small') || src.includes('_thumb') || src.includes('32x32') || src.includes('64x64')) {
      return;
    }
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆURLã®åŸºæœ¬éƒ¨åˆ†ã§æ¯”è¼ƒï¼‰
    const baseUrl = src.split('?')[0];
    if (!seenUrls.has(baseUrl) && src.includes('files/')) {
      seenUrls.add(baseUrl);
      imageUrls.push(src);
    }
  });
  
  // ç”»åƒã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤º
  if (imageUrls.length > 0) {
    const imageGrid = document.getElementById('imageGrid');
    imageGrid.innerHTML = '';
    
    imageUrls.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'image-grid-item';
      div.setAttribute('data-url', url);
      div.innerHTML = `
        <img src="${url}" data-url="${url}" onclick="toggleImageSelection(this.parentElement)">
        <div class="checkmark">âœ“</div>
      `;
      imageGrid.appendChild(div);
    });
    
    document.getElementById('extractedImages').style.display = 'block';
  }
  
  // å•†å“ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
  const bodyText = doc.body?.textContent || '';
  const detectedPoints = [];
  
  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³
  const patterns = [
    { regex: /17\s*ã‚¤ãƒ³ãƒ.*(?:PC|ãƒ‘ã‚½ã‚³ãƒ³|ãƒãƒ¼ãƒˆ).*(?:åç´|å¯¾å¿œ|OK)/i, text: '17ã‚¤ãƒ³ãƒã®PC åç´OK' },
    { regex: /15\s*ã‚¤ãƒ³ãƒ.*(?:PC|ãƒ‘ã‚½ã‚³ãƒ³|ãƒãƒ¼ãƒˆ).*(?:åç´|å¯¾å¿œ|OK)/i, text: '15ã‚¤ãƒ³ãƒã®PC åç´OK' },
    { regex: /13\s*ã‚¤ãƒ³ãƒ.*(?:PC|ãƒ‘ã‚½ã‚³ãƒ³|ãƒãƒ¼ãƒˆ).*(?:åç´|å¯¾å¿œ|OK)/i, text: '13ã‚¤ãƒ³ãƒã®PC åç´OK' },
    { regex: /A4.*(?:ãƒ•ã‚¡ã‚¤ãƒ«|ã‚µã‚¤ã‚º).*(?:åç´|å¯¾å¿œ|OK)/i, text: 'A4ãƒ•ã‚¡ã‚¤ãƒ« åç´OK' },
    { regex: /ãƒšãƒƒãƒˆãƒœãƒˆãƒ«.*(?:åç´|ãƒã‚±ãƒƒãƒˆ|OK)/i, text: 'ãƒšãƒƒãƒˆãƒœãƒˆãƒ«åç´OK' },
    { regex: /æ’¥æ°´/i, text: 'æ’¥æ°´åŠ å·¥' },
    { regex: /ãƒ¡ãƒƒã‚·ãƒ¥.*ãƒã‚±ãƒƒãƒˆ/i, text: 'ãƒ¡ãƒƒã‚·ãƒ¥ãƒã‚±ãƒƒãƒˆã§ä¸­èº«ãŒè¦‹ãˆã‚‹' },
    { regex: /2\s*æ®µ.*æ§‹é€ |äºŒæ®µ.*æ§‹é€ |è¦³éŸ³é–‹ã/i, text: '2æ®µæ§‹é€ ã§æ•´ç†ã—ã‚„ã™ã„' },
    { regex: /è¦–èªæ€§/i, text: 'è¦–èªæ€§ã«å„ªã‚ŒãŸè¨­è¨ˆ' },
    { regex: /è»½é‡|è»½ã„/i, text: 'è»½é‡è¨­è¨ˆ' },
    { regex: /ä¿å†·|ä¿æ¸©/i, text: 'ä¿å†·ãƒ»ä¿æ¸©æ©Ÿèƒ½ä»˜ã' },
    { regex: /è‡ªç«‹/i, text: 'è‡ªç«‹ã™ã‚‹è¨­è¨ˆ' },
  ];
  
  patterns.forEach(pattern => {
    if (pattern.regex.test(bodyText)) {
      detectedPoints.push(pattern.text);
    }
  });
  
  // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’æŠ½å‡º
  const sizeMatch = bodyText.match(/(?:é«˜ã•|H)\s*[:ï¼š]?\s*(\d+)\s*(?:cm|ã)?\s*[Ã—x]\s*(?:æ¨ª|å¹…|W)\s*[:ï¼š]?\s*(\d+)\s*(?:cm|ã)?\s*[Ã—x]\s*(?:ãƒãƒ|å¥¥è¡Œ|D)\s*[:ï¼š]?\s*(\d+)/i);
  if (sizeMatch) {
    document.getElementById('size').value = `é«˜ã•${sizeMatch[1]}cm Ã— æ¨ª${sizeMatch[2]}cm Ã— ãƒãƒ${sizeMatch[3]}cm`;
  }
  
  // å®¹é‡ã‚’æŠ½å‡º
  const capacityMatch = bodyText.match(/(\d+)\s*[Lâ„“ãƒªãƒƒãƒˆãƒ«]/);
  if (capacityMatch) {
    document.getElementById('capacity').value = capacityMatch[1] + 'L';
  }
  
  // é‡ã•ã‚’æŠ½å‡º
  const weightMatch = bodyText.match(/(\d+)\s*[gã‚°ãƒ©ãƒ ]/);
  if (weightMatch) {
    document.getElementById('weight').value = weightMatch[1] + 'g';
  }
  
  // ãƒã‚¤ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
  if (detectedPoints.length > 0) {
    const pointsList = document.getElementById('pointsList');
    pointsList.innerHTML = '';
    
    detectedPoints.forEach((point, index) => {
      const label = document.createElement('label');
      label.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;';
      label.innerHTML = `
        <input type="checkbox" checked value="${point}" style="margin-right: 8px; width: 16px; height: 16px;">
        ${point}
      `;
      pointsList.appendChild(label);
    });
    
    document.getElementById('extractedPoints').style.display = 'block';
  }
  
  // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚µã‚¸ã‚§ã‚¹ãƒˆç”¨ã«èª¬æ˜æ–‡ã‚’æŠ½å‡º
  extractedCaptions = [];
  const paragraphs = doc.querySelectorAll('p, h2, h3, .caption, .description');
  paragraphs.forEach(p => {
    const text = p.textContent.trim();
    // é©åˆ‡ãªé•·ã•ã®èª¬æ˜æ–‡ã®ã¿æŠ½å‡º
    if (text.length > 10 && text.length < 100 && !text.includes('Qï¼š') && !text.includes('Aï¼š')) {
      if (!extractedCaptions.includes(text)) {
        extractedCaptions.push(text);
      }
    }
  });
  
  // ã‚«ãƒ©ãƒ¼æƒ…å ±ã‚’æŠ½å‡º
  extractedColors = [];
  const colorPatterns = [
    /ãƒ–ãƒ©ãƒƒã‚¯|é»’/g, /ãƒ›ãƒ¯ã‚¤ãƒˆ|ç™½/g, /ãƒã‚¤ãƒ“ãƒ¼|ç´º/g, /ã‚°ãƒ¬ãƒ¼|ç°/g,
    /ãƒ™ãƒ¼ã‚¸ãƒ¥/g, /ãƒ–ãƒ©ã‚¦ãƒ³|èŒ¶/g, /ãƒ¬ãƒƒãƒ‰|èµ¤/g, /ãƒ–ãƒ«ãƒ¼|é’/g,
    /ã‚°ãƒªãƒ¼ãƒ³|ç·‘/g, /ã‚¤ã‚¨ãƒ­ãƒ¼|é»„/g, /ã‚ªãƒ¬ãƒ³ã‚¸|æ©™/g, /ãƒ”ãƒ³ã‚¯/g,
    /ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼/g, /ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼/g, /ãƒãƒ£ã‚³ãƒ¼ãƒ«/g, /ã‚«ãƒ¼ã‚­/g
  ];
  // ã€Œï¼ˆå†…è£…ã€œï¼‰ã€ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚æŠ½å‡º
  const colorWithLiningPattern = /(?:ãƒ–ãƒ©ãƒƒã‚¯|ãƒ›ãƒ¯ã‚¤ãƒˆ|ãƒã‚¤ãƒ“ãƒ¼|ã‚°ãƒ¬ãƒ¼|ãƒ™ãƒ¼ã‚¸ãƒ¥|ãƒ–ãƒ©ã‚¦ãƒ³|ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼|ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼|ãƒãƒ£ã‚³ãƒ¼ãƒ«|ã‚«ãƒ¼ã‚­)(?:ï¼ˆå†…è£…[^ï¼‰]+ï¼‰)?/g;
  const colorMatches = bodyText.match(colorWithLiningPattern);
  if (colorMatches) {
    colorMatches.forEach(c => {
      if (!extractedColors.includes(c)) {
        extractedColors.push(c);
      }
    });
  }
  
  // ã‚µã‚¤ã‚ºæƒ…å ±ã‚’æŠ½å‡ºï¼ˆã‚µã‚¸ã‚§ã‚¹ãƒˆç”¨ï¼‰
  extractedSizes = [];
  const sizePatterns = [
    /(?:é«˜ã•|H)\s*[:ï¼š]?\s*\d+\s*(?:cm|ã)?\s*[Ã—x]\s*(?:æ¨ª|å¹…|W)\s*[:ï¼š]?\s*\d+\s*(?:cm|ã)?\s*[Ã—x]\s*(?:ãƒãƒ|å¥¥è¡Œ|D)\s*[:ï¼š]?\s*\d+\s*(?:cm|ã)?/gi,
    /\d+\s*(?:cm|ã)\s*[Ã—x]\s*\d+\s*(?:cm|ã)\s*[Ã—x]\s*\d+\s*(?:cm|ã)/gi
  ];
  sizePatterns.forEach(pattern => {
    const matches = bodyText.match(pattern);
    if (matches) {
      matches.forEach(s => {
        const cleaned = s.trim();
        if (!extractedSizes.includes(cleaned)) {
          extractedSizes.push(cleaned);
        }
      });
    }
  });
  
  // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œã‚’UIã«è¡¨ç¤º
  if (extractedCaptions.length > 0) {
    const captionsList = document.getElementById('captionsList');
    captionsList.innerHTML = extractedCaptions.map(c => `<div style="padding: 4px 0; border-bottom: 1px solid #eee;">â€¢ ${c}</div>`).join('');
    document.getElementById('extractedCaptionsDiv').style.display = 'block';
  }
  
  updatePreview();
  alert('è§£æãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nãƒ»å•†å“å: ' + (title ? 'æ¤œå‡º' : 'æœªæ¤œå‡º') + '\nãƒ»ç”»åƒ: ' + imageUrls.length + 'ä»¶\nãƒ»å•†å“ãƒã‚¤ãƒ³ãƒˆ: ' + detectedPoints.length + 'ä»¶\nãƒ»ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œ: ' + extractedCaptions.length + 'ä»¶\nãƒ»ã‚«ãƒ©ãƒ¼å€™è£œ: ' + extractedColors.length + 'ä»¶\n\nç”»åƒã‚’é¸æŠã—ã¦è¿½åŠ ã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
}

// ç”»åƒé¸æŠã®ãƒˆã‚°ãƒ«
function toggleImageSelection(item) {
  // ä½¿ç”¨æ¸ˆã¿ã®ç”»åƒã¯é¸æŠä¸å¯
  if (item.classList.contains('used')) {
    return;
  }
  item.classList.toggle('selected');
}

// é¸æŠã—ãŸç”»åƒã‚’é©ç”¨
function applySelectedImages(target) {
  const selectedItems = document.querySelectorAll('#imageGrid .image-grid-item.selected');
  
  if (selectedItems.length === 0) {
    alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  if (target === 'detail') {
    selectedItems.forEach((item, index) => {
      const url = item.getAttribute('data-url');
      addDetailItemWithUrl(url, index === 0); // æœ€åˆã®ç”»åƒã®ã¿ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
      // ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
      item.classList.remove('selected');
      item.classList.add('used');
    });
  } else if (target === 'slider') {
    selectedItems.forEach((item, index) => {
      const url = item.getAttribute('data-url');
      addSliderItemWithUrl(url, index === 0); // æœ€åˆã®ç”»åƒã®ã¿ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
      // ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
      item.classList.remove('selected');
      item.classList.add('used');
    });
  }
  
  updatePreview();
  
  if (extractedCaptions.length > 0) {
    alert(selectedItems.length + 'ä»¶ã®ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\n\nã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚\nã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
  } else {
    alert(selectedItems.length + 'ä»¶ã®ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
  }
}

// URLä»˜ãã§å•†å“è©³ç´°ã‚’è¿½åŠ 
function addDetailItemWithUrl(url, showSuggest = false) {
  const list = document.getElementById('productDetailList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.draggable = true;
  item.ondragstart = dragStart;
  item.ondragover = dragOver;
  item.ondrop = function(e) { drop(e, 'productDetailList'); };
  item.ondragend = dragEnd;
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <div class="image-item-wrapper">
      <div class="move-buttons">
        <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
        <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
      </div>
      <img src="${url}" class="image-thumbnail" onerror="this.style.display='none'">
      <div class="image-inputs">
        <label>ç”»åƒURL</label>
        <input type="url" class="detail-img" value="${url}" oninput="updatePreview(); updateThumbnail(this, 'detail')">
        <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
        <textarea class="detail-caption" placeholder="ä¾‹ï¼šã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«ç´ æã‚’æ„Ÿã˜ã¦ã‚‚ã‚‰ãˆã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¶ã‚¤ãƒ³ã€‚" oninput="updatePreview()"></textarea>
      </div>
    </div>
  `;
  list.appendChild(item);
  
  // ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’è‡ªå‹•è¡¨ç¤º
  if (showSuggest && extractedCaptions.length > 0) {
    setTimeout(() => {
      const btn = item.querySelector('.auto-generate-btn');
      if (btn) generateCaption(btn);
    }, 100);
  }
}

// URLä»˜ãã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’è¿½åŠ 
function addSliderItemWithUrl(url, showSuggest = false) {
  const list = document.getElementById('sliderList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.draggable = true;
  item.ondragstart = dragStart;
  item.ondragover = dragOver;
  item.ondrop = function(e) { drop(e, 'sliderList'); };
  item.ondragend = dragEnd;
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <div class="image-item-wrapper">
      <div class="move-buttons">
        <button type="button" class="move-btn" onclick="moveItem(this, -1)">â–²</button>
        <button type="button" class="move-btn" onclick="moveItem(this, 1)">â–¼</button>
      </div>
      <img src="${url}" class="image-thumbnail" onerror="this.style.display='none'">
      <div class="image-inputs">
        <label>ç”»åƒURL</label>
        <input type="url" class="slider-img" value="${url}" oninput="updatePreview(); updateThumbnail(this, 'slider')">
        <label>ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ <button type="button" class="auto-generate-btn" onclick="generateCaption(this)">âœ¨ è‡ªå‹•ç”Ÿæˆ</button></label>
        <input type="text" class="slider-caption" placeholder="ä¾‹ï¼šå¹…åºƒã„ã‚µã‚¤ã‚ºå±•é–‹" oninput="updatePreview()">
      </div>
    </div>
  `;
  list.appendChild(item);
  
  // ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’è‡ªå‹•è¡¨ç¤º
  if (showSuggest && extractedCaptions.length > 0) {
    setTimeout(() => {
      const btn = item.querySelector('.auto-generate-btn');
      if (btn) generateCaption(btn);
    }, 100);
  }
}

// é¸æŠã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’é©ç”¨
function applySelectedPoints() {
  const checkboxes = document.querySelectorAll('#pointsList input[type="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  // è³¼å…¥å‰ã«çŸ¥ã£ã¦ãŠããŸã„ã“ã¨ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
  const beforePurchaseCheckboxes = document.querySelectorAll('#beforePurchaseCheckboxes input[type="checkbox"]');
  
  checkboxes.forEach(cb => {
    const value = cb.value;
    let found = false;
    
    beforePurchaseCheckboxes.forEach(bpc => {
      if (bpc.value === value) {
        bpc.checked = true;
        found = true;
      }
    });
    
    // æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãªã„å ´åˆã¯ã€Œãã®ä»–ã€ã¨ã—ã¦è¿½åŠ 
    if (!found) {
      addBeforePurchaseItemWithValue(value);
    }
  });
  
  updatePreview();
  alert(checkboxes.length + 'ä»¶ã®ãƒã‚¤ãƒ³ãƒˆã‚’åæ˜ ã—ã¾ã—ãŸ');
}

// å€¤ä»˜ãã§è³¼å…¥å‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
function addBeforePurchaseItemWithValue(value) {
  const list = document.getElementById('beforePurchaseList');
  const item = document.createElement('div');
  item.className = 'dynamic-item';
  item.innerHTML = `
    <button type="button" class="delete-btn" onclick="deleteItem(this)">Ã—</button>
    <label>é …ç›®</label>
    <input type="text" class="before-purchase-other" value="${value}" oninput="updatePreview()">
  `;
  list.appendChild(item);
}

// ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
function updateThumbnail(input, type) {
  const url = input.value;
  const wrapper = input.closest('.image-item-wrapper');
  let thumbnail = wrapper.querySelector('.image-thumbnail');
  let placeholder = wrapper.querySelector('.image-thumbnail-placeholder');
  
  if (url && url.startsWith('http')) {
    if (placeholder) {
      const img = document.createElement('img');
      img.src = url;
      img.className = 'image-thumbnail';
      img.onerror = function() { this.style.display = 'none'; };
      placeholder.replaceWith(img);
    } else if (thumbnail) {
      thumbnail.src = url;
      thumbnail.style.display = 'block';
    }
  } else {
    if (thumbnail) {
      const div = document.createElement('div');
      div.className = 'image-thumbnail-placeholder';
      div.innerHTML = 'ç”»åƒ<br>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
      thumbnail.replaceWith(div);
    }
  }
}

// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
let draggedItem = null;

function dragStart(e) {
  draggedItem = e.target.closest('.dynamic-item');
  draggedItem.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function dragOver(e) {
  e.preventDefault();
  const item = e.target.closest('.dynamic-item');
  if (item && item !== draggedItem) {
    item.classList.add('drag-over');
  }
}

function dragEnd(e) {
  document.querySelectorAll('.dynamic-item').forEach(item => {
    item.classList.remove('dragging', 'drag-over');
  });
  draggedItem = null;
}

function drop(e, listId) {
  e.preventDefault();
  const dropTarget = e.target.closest('.dynamic-item');
  const list = document.getElementById(listId);
  
  if (dropTarget && draggedItem && dropTarget !== draggedItem) {
    const items = Array.from(list.children);
    const draggedIndex = items.indexOf(draggedItem);
    const dropIndex = items.indexOf(dropTarget);
    
    if (draggedIndex < dropIndex) {
      dropTarget.after(draggedItem);
    } else {
      dropTarget.before(draggedItem);
    }
    
    updatePreview();
  }
  
  document.querySelectorAll('.dynamic-item').forEach(item => {
    item.classList.remove('drag-over');
  });
}

// ä¸Šä¸‹ãƒœã‚¿ãƒ³ã§ç§»å‹•
function moveItem(btn, direction) {
  const item = btn.closest('.dynamic-item');
  const list = item.parentElement;
  const items = Array.from(list.children);
  const index = items.indexOf(item);
  
  if (direction === -1 && index > 0) {
    // ä¸Šã«ç§»å‹•
    list.insertBefore(item, items[index - 1]);
  } else if (direction === 1 && index < items.length - 1) {
    // ä¸‹ã«ç§»å‹•
    list.insertBefore(items[index + 1], item);
  }
  
  updatePreview();
}
</script>

</body>
</html>
