<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KABAG è¨ºæ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body, #root { height: 100%; overflow: hidden; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useCallback, useEffect } = React;

// ===== Initial node positions (tree layout) =====
function layoutTree(questions, results) {
  const nodes = {};
  const visited = new Set();
  const positions = {};
  
  // Build adjacency
  const qMap = {};
  questions.forEach(q => { qMap[q.id] = q; });
  const rSet = new Set(results.map(r => r.id));

  // BFS to assign positions
  const queue = [{ id: questions[0]?.id, depth: 0, index: 0, parentCount: 1 }];
  const depthCount = {};
  const depthNodes = {};
  
  // First pass: determine depth of each node
  const nodeDepth = {};
  const bfsQueue = [questions[0]?.id];
  const bfsVisited = new Set();
  let maxDepth = 0;
  
  while (bfsQueue.length > 0) {
    const id = bfsQueue.shift();
    if (!id || bfsVisited.has(id)) continue;
    bfsVisited.add(id);
    
    const depth = nodeDepth[id] || 0;
    maxDepth = Math.max(maxDepth, depth);
    
    if (!depthNodes[depth]) depthNodes[depth] = [];
    depthNodes[depth].push(id);
    
    if (qMap[id]) {
      const q = qMap[id];
      [q.n1, q.n2].forEach(nid => {
        if (nid && !bfsVisited.has(nid)) {
          nodeDepth[nid] = depth + 1;
          bfsQueue.push(nid);
        }
      });
    }
  }

  // Assign positions
  Object.keys(depthNodes).forEach(d => {
    const dep = parseInt(d);
    const items = depthNodes[dep];
    const totalWidth = items.length * 220;
    const startX = -totalWidth / 2 + 110;
    items.forEach((id, i) => {
      positions[id] = { x: startX + i * 220, y: dep * 160 + 40 };
    });
  });

  // Any nodes not positioned
  let extraX = 0;
  [...questions, ...results].forEach(item => {
    if (!positions[item.id]) {
      positions[item.id] = { x: extraX, y: (maxDepth + 1) * 160 + 40 };
      extraX += 220;
    }
  });

  return positions;
}

// ===== Initial Data =====
const initQ = [
  { id:"Q1", label:"Q1", text:"ä»Šã®ãƒãƒƒã‚°ã§ä¸€ç•ª\nå›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿ", desc:"", icon1:"ğŸ”", icon2:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", c1:"ãƒ¢ãƒãŒè¦‹ã¤ã‹ã‚‰ãªã„", c1sub:"", c2:"å®¶æ—ã®ãŠå‡ºã‹ã‘æº–å‚™ãŒå¤§å¤‰", c2sub:"", n1:"Q2", n2:"Q2F" },
  { id:"Q2", label:"Q2", text:"æ•´ç†ã®æ‚©ã¿ã€\nã©ã¡ã‚‰ã«è¿‘ã„ï¼Ÿ", desc:"", icon1:"â±", icon2:"ğŸ§©", c1:"æ§‹é€ ã•ãˆè‰¯ã‘ã‚Œã°è§£æ±ºã§ããã†", c1sub:"", c2:"æ•´ç†ãã®ã‚‚ã®ãŒè‹¦æ‰‹", c2sub:"", n1:"Q3T", n2:"Q3A" },
  { id:"Q3T", label:"Q3", text:"æŒã¡ç‰©ã®é‡ã¯ï¼Ÿ", desc:"", icon1:"ğŸ’¼", icon2:"ğŸª¶", c1:"ã—ã£ã‹ã‚ŠæŒã¡æ­©ã", c1sub:"", c2:"èº«è»½ã«å‹•ããŸã„", c2sub:"", n1:"Q4TF", n2:"Q4TM" },
  { id:"Q4TF", label:"Q4", text:"ãƒãƒƒã‚°ã®å½¢ã¯ï¼Ÿ", desc:"", icon1:"ğŸ’", icon2:"ğŸ‘œ", c1:"ãƒªãƒ¥ãƒƒã‚¯æ´¾", c1sub:"", c2:"ãƒˆãƒ¼ãƒˆãƒ»å¤šæ©Ÿèƒ½æ´¾", c2sub:"", n1:"Q5TR", n2:"Q5TT" },
  { id:"Q5TR", label:"Q5", text:"ãƒªãƒ¥ãƒƒã‚¯ã®æ©Ÿèƒ½ã¯ï¼Ÿ", desc:"", icon1:"ğŸ–¥ï¸", icon2:"âœ¨", c1:"æœ¬æ ¼æ´¾", c1sub:"", c2:"ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ/æ‰‹é ƒ", c2sub:"", n1:"Q6TH", n2:"Q6TC" },
  { id:"Q6TH", label:"Q6", text:"åˆ©ãæ‰‹ã¯ï¼Ÿ", desc:"", icon1:"âœ‹", icon2:"ğŸ¤š", c1:"å³åˆ©ã", c1sub:"", c2:"å·¦åˆ©ã", c2sub:"", n1:"R_box2R", n2:"R_box2L" },
  { id:"Q6TC", label:"Q6", text:"äºˆç®—æ„Ÿã¯ï¼Ÿ", desc:"", icon1:"ğŸ’", icon2:"ğŸŒ±", c1:"ã—ã£ã‹ã‚ŠæŠ•è³‡", c1sub:"", c2:"æ‰‹è»½ã«è©¦ã—ãŸã„", c2sub:"", n1:"R_boxmini2", n2:"Q7TE" },
  { id:"Q7TE", label:"Q7", text:"ã‚µã‚¤ã‚ºã¯ï¼Ÿ", desc:"", icon1:"ğŸ“¦", icon2:"ğŸ“", c1:"ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ", c1sub:"", c2:"ä½™è£•ã»ã—ã„", c2sub:"", n1:"R_jitanM", n2:"R_jitanL" },
  { id:"Q5TT", label:"Q5", text:"ã©ã¡ã‚‰ãŒå¥½ãï¼Ÿ", desc:"", icon1:"ğŸ‘œ", icon2:"ğŸ”„", c1:"ãƒˆãƒ¼ãƒˆ", c1sub:"", c2:"å¤šæ©Ÿèƒ½ãƒ»å¤‰å½¢", c2sub:"", n1:"R_address", n2:"R_wonder" },
  { id:"Q4TM", label:"Q4", text:"ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã‚‚æŒã¤ï¼Ÿ", desc:"", icon1:"ğŸ§´", icon2:"ğŸª¶", c1:"æŒã¡æ­©ã", c1sub:"", c2:"æœ€å°é™ã§OK", c2sub:"", n1:"Q5TP", n2:"Q5TW" },
  { id:"Q5TP", label:"Q5", text:"ï¼‹Î±ã®è·ç‰©ã¯ï¼Ÿ", desc:"", icon1:"ğŸ“±", icon2:"â˜‚ï¸", c1:"å°‘ã—", c1sub:"", c2:"å‚˜ã‚„ãƒãƒ¼ãƒã‚‚", c2sub:"", n1:"R_spot", n2:"R_clinic" },
  { id:"Q5TW", label:"Q5", text:"æŒã¡æ–¹ã¯ï¼Ÿ", desc:"", icon1:"ğŸ‘", icon2:"ğŸ”€", c1:"ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼", c1sub:"", c2:"2WAY", c2sub:"", n1:"R_with", n2:"R_sack" },
  { id:"Q3A", label:"Q3", text:"è·ç‰©ã®é‡ã¯ï¼Ÿ", desc:"å°‚é–€å®¶ã¨667äººã®å£°ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã‚·ãƒªãƒ¼ã‚º", icon1:"ğŸ“š", icon2:"ğŸ“±", c1:"å¤šã‚", c1sub:"", c2:"æ™®é€šã€œå°‘ãªã‚", c2sub:"", n1:"Q4AL", n2:"Q4AR" },
  { id:"Q4AL", label:"Q4", text:"ç´ æã®å¥½ã¿ã¯ï¼Ÿ", desc:"", icon1:"ğŸ›¡ï¸", icon2:"ğŸª¶", c1:"ä¸ˆå¤«ã•é‡è¦–", c1sub:"", c2:"è»½ã•é‡è¦–", c2sub:"", n1:"R_adhd_BL", n2:"R_adhd_TL" },
  { id:"Q4AR", label:"Q4", text:"ç´ æã®å¥½ã¿ã¯ï¼Ÿ", desc:"", icon1:"ğŸ›¡ï¸", icon2:"ğŸª¶", c1:"ä¸ˆå¤«ã•é‡è¦–", c1sub:"", c2:"è»½ã•é‡è¦–", c2sub:"", n1:"R_adhd_BR", n2:"R_adhd_TR" },
  { id:"Q2F", label:"Q2", text:"èª°ã®ãŸã‚ã®ãƒãƒƒã‚°ï¼Ÿ", desc:"", icon1:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", icon2:"ğŸ‘¶", c1:"è¦ªï¼ˆè‡ªåˆ†ï¼‰ç”¨", c1sub:"", c2:"å­ã©ã‚‚é–¢é€£", c2sub:"", n1:"Q3FP", n2:"Q3FK" },
  { id:"Q3FP", label:"Q3", text:"ä¸»ãªç”¨é€”ã¯ï¼Ÿ", desc:"", icon1:"ğŸ’", icon2:"ğŸ›’", c1:"ãŠå‡ºã‹ã‘ãƒªãƒ¥ãƒƒã‚¯", c1sub:"", c2:"è²·ã„ç‰©ï¼ˆä¿æ¸©ä¿å†·ï¼‰", c2sub:"", n1:"Q4FPR", n2:"Q4FC" },
  { id:"Q4FPR", label:"Q4", text:"èª°ãŒä½¿ã†ï¼Ÿ", desc:"", icon1:"ğŸ‘©", icon2:"ğŸ‘¨", c1:"ãƒãƒ", c1sub:"", c2:"ãƒ‘ãƒ‘", c2sub:"", n1:"R_mothers2", n2:"R_fathers" },
  { id:"Q4FC", label:"Q4", text:"è²·ã„ç‰©ã®é‡ã¯ï¼Ÿ", desc:"", icon1:"ğŸ¥›", icon2:"ğŸ›’", c1:"æ—¥å¸¸çš„", c1sub:"", c2:"ã¾ã¨ã‚è²·ã„", c2sub:"", n1:"R_cold_R", n2:"R_cold_L" },
  { id:"Q3FK", label:"Q3", text:"ã©ã‚“ãªãƒãƒƒã‚°ï¼Ÿ", desc:"", icon1:"ğŸ’", icon2:"ğŸ¤±", c1:"å­ã©ã‚‚ç”¨ãƒªãƒ¥ãƒƒã‚¯", c1sub:"", c2:"æŠ±ã£ã“ç´ä»˜ã", c2sub:"", n1:"Q4FKD", n2:"R_hug" },
  { id:"Q4FKD", label:"Q4", text:"ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ï¼Ÿ", desc:"", icon1:"ğŸš„", icon2:"ğŸš—", c1:"æ–°å¹¹ç·š", c1sub:"", c2:"ãã‚‹ã¾", c2sub:"", n1:"Q5FKS", n2:"R_car" },
  { id:"Q5FKS", label:"Q5", text:"ã©ã®æ–°å¹¹ç·šï¼Ÿ", desc:"", icon1:"ğŸ’š", icon2:"ğŸ’›", c1:"ã¯ã‚„ã¶ã•", c1sub:"", c2:"ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚¤ã‚¨ãƒ­ãƒ¼", c2sub:"", n1:"R_hayabusa", n2:"R_dryellow" },
];

const initR = [
  { id:"R_boxmini2", cat:"time", catLabel:"æ™‚çŸ­", type:"æ¯æœã‚«ãƒãƒ³ã®åº•ã‚’æ¼ã‚‹äºº", name:"box mini 2", code:"5503", price:"13,200", catch:"æ¢ã•ãªã„ã€‚è¿·ã‚ãªã„ã€‚", before:"è²¡å¸ƒãŒè¦‹ã¤ã‹ã‚‰ãªã„", after:"æ‰‹ã‚’å…¥ã‚ŒãŸç¬é–“ã«è§¦ã‚Œã‚‹", points:"âœ… ç«‹ä½“åç´\nâœ… 15ã‚¤ãƒ³ãƒPCå¯¾å¿œ\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæ¢ã—ã‚„ã™ã„ã€", url:"/products/kabag_box_mini2" },
  { id:"R_box2R", cat:"time", catLabel:"æ™‚çŸ­", type:"è·ç‰©ãŒå¤šã„äºº(å³)", name:"box 2 å³åˆ©ã", code:"5376", price:"13,750", catch:"å¤§å®¹é‡ã§è¦‹ãˆã‚‹", before:"åº•ã®ç‰©ãŒå‡ºã›ãªã„", after:"3å®¤ã§å®šä½ç½®", points:"âœ… 3å®¤æ§‹é€ \nâœ… å³åˆ©ãå°‚ç”¨\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œä½¿ã„ã‚„ã™ã„ã€", url:"/products/el5376" },
  { id:"R_box2L", cat:"time", catLabel:"æ™‚çŸ­", type:"å·¦åˆ©ãã®äºº", name:"box 2 å·¦åˆ©ã", code:"5400", price:"13,750", catch:"å·¦åˆ©ãå°‚ç”¨", before:"å³åˆ©ãè¨­è¨ˆã§ä¸ä¾¿", after:"è‡ªç„¶ãªå‹•ä½œã§ã‚¢ã‚¯ã‚»ã‚¹", points:"âœ… å·¦åˆ©ãå°‚ç”¨\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œå·¦åˆ©ãã«æœ€é©ã€", url:"/products/el5400" },
  { id:"R_jitanM", cat:"time", catLabel:"æ™‚çŸ­", type:"æ‰‹è»½ã«ä½“é¨“ã—ãŸã„äºº", name:"æ™‚çŸ­ãƒªãƒ¥ãƒƒã‚¯ M", code:"5517", price:"8,990", catch:"ã¾ãšã¯ä½“é¨“ã€‚", before:"é«˜ã„ãƒãƒƒã‚°ã§å¤±æ•—ãŒæ€–ã„", after:"æ‰‹é ƒã«æ™‚çŸ­ã‚’ä½“é¨“", points:"âœ… Â¥8,990\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œè‰²é•ã„æ¤œè¨ä¸­ã€", url:"/products/5517" },
  { id:"R_jitanL", cat:"time", catLabel:"æ™‚çŸ­", type:"æ‰‹è»½+ä½™è£•ã‚µã‚¤ã‚º", name:"æ™‚çŸ­ãƒªãƒ¥ãƒƒã‚¯ L", code:"5518", price:"9,900", catch:"ä½™è£•ã®ã‚µã‚¤ã‚ºã€‚", before:"ä¸­ãŒã‚«ã‚ªã‚¹", after:"ãŸã£ã·ã‚Šåç´ã§æ•´ç†", points:"âœ… Â¥9,900\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæˆ»ã‚Œã¾ã›ã‚“ã€", url:"/products/5518" },
  { id:"R_address", cat:"time", catLabel:"æ™‚çŸ­", type:"ãƒˆãƒ¼ãƒˆæ´¾ã®äºº", name:"address", code:"5502", price:"13,200", catch:"2éšå»ºã¦ãƒˆãƒ¼ãƒˆ", before:"åº•ã§ãƒ¢ãƒãŒæ··ã–ã‚‹", after:"ä½æ‰€ãŒæ±ºã¾ã‚‹", points:"âœ… 2éšå»ºã¦\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œä»–ã«ãªã„æ•´ç†åŠ›ã€", url:"/products/kabag_address" },
  { id:"R_wonder", cat:"time", catLabel:"æ™‚çŸ­", type:"ä½•å½¹ã‚‚ã“ãªã—ãŸã„äºº", name:"wonder", code:"8540", price:"16,500", catch:"å¤‰å½¢ãƒªãƒ¥ãƒƒã‚¯", before:"ãƒãƒƒã‚°å¢—ãˆç¶šã‘ã‚‹", after:"ã“ã‚Œ1ã¤ã§å¯¾å¿œ", points:"âœ… å¤‰å½¢\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œä¸‡èƒ½ã€", url:"/products/el8540" },
  { id:"R_spot", cat:"time", catLabel:"æ™‚çŸ­", type:"èº«è»½+ãƒšãƒƒãƒˆãƒœãƒˆãƒ«", name:"spot", code:"8665", price:"7,590", catch:"èº«è»½ãƒã‚·ã‚§ãƒƒãƒˆ", before:"ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ã®ç½®ãå ´", after:"å°‚ç”¨åç´ä»˜ã", points:"âœ… ãƒšãƒƒãƒˆãƒœãƒˆãƒ«åç´\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œã™ã£ã½ã‚Šå…¥ã‚‹ã€", url:"/products/kabag-spot" },
  { id:"R_clinic", cat:"time", catLabel:"æ™‚çŸ­", type:"å¤–å‡ºã§æ•´ç†ã—ãŸã„äºº", name:"clinic", code:"5352", price:"6,490", catch:"å¤šåç´ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼", before:"åç´å°‘ãªã™ã", after:"å‚˜ã¾ã§å…¥ã‚‹", points:"âœ… å¤šãƒã‚±ãƒƒãƒˆ\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œå½“ãŸã‚Šå‰ã«åç´ã€", url:"/products/el5352" },
  { id:"R_with", cat:"time", catLabel:"æ™‚çŸ­", type:"è¶…ãƒŸãƒ‹ãƒãƒ«æ´¾", name:"with", code:"5369", price:"4,290", catch:"æ‰‹ã¶ã‚‰æ„Ÿè¦š", before:"ãƒã‚±ãƒƒãƒˆã ã‘ã§ã¯ä¸å®‰", after:"è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ", points:"âœ… Â¥4,290\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæ‰‹ã¶ã‚‰æ„Ÿè¦šã€", url:"/products/el5369" },
  { id:"R_sack", cat:"time", catLabel:"æ™‚çŸ­", type:"è¶…ãƒŸãƒ‹ãƒãƒ«æ´¾2WAY", name:"sack", code:"8366", price:"4,290", catch:"2WAYãƒŸãƒ‹ãƒãƒ«", before:"å¤§ãã„ãƒãƒƒã‚°å«Œ", after:"2WAYã§è‡ªç”±", points:"âœ… Â¥4,290\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œã‚µãƒƒã¨ä½¿ãˆã‚‹ã€", url:"/products/el8366" },
  { id:"R_adhd_BL", cat:"adhd", catLabel:"ADHD", type:"åŠªåŠ›ãªã—æ•´ç†(å¤§ãƒ»ä¸ˆå¤«)", name:"ADHD ãƒãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ L", code:"5510", price:"19,800", catch:"ã—ãã¿ã§æ•´ç†", before:"ä½•åº¦ç‰‡ä»˜ã‘ã¦ã‚‚æˆ»ã‚‹", after:"é…ç½®ã‚·ãƒ¼ãƒ«ã§è¦–è¦šåŒ–", points:"âœ… å°‚é–€å®¶é–‹ç™º\nâœ… ç‰¹è¨±å–å¾—\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œé­”æ³•ã®ãƒªãƒ¥ãƒƒã‚¯ã€", url:"/products/adhd-bl" },
  { id:"R_adhd_TL", cat:"adhd", catLabel:"ADHD", type:"è»½ã•+æ•´ç†(å¤§)", name:"ADHD ãƒ„ã‚¤ãƒ« L", code:"5512", price:"17,600", catch:"è»½ãã¦æ•´ç†ã§ãã‚‹", before:"é‡ãã¦ä½¿ã‚ãªããªã‚‹", after:"æ¯æ—¥æŒã¦ã‚‹è»½ã•", points:"âœ… ãƒ„ã‚¤ãƒ«è»½é‡\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œãƒãƒ¼ã‚¹ãƒˆãƒ¬ã‚¹ã€", url:"/products/adhd-tl" },
  { id:"R_adhd_BR", cat:"adhd", catLabel:"ADHD", type:"ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ+ä¸ˆå¤«", name:"ADHD ãƒãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ R", code:"5513", price:"18,700", catch:"å°ã•ãã¦ã‚‚å¼·ã„", before:"ãƒ˜ã‚¿ã‚Šã‚„ã™ã„", after:"é•·æŒã¡ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ", points:"âœ… é«˜è€ä¹…\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæ°—æŒã¡ãŒæ¥½ã«ã€", url:"/products/adhd-br" },
  { id:"R_adhd_TR", cat:"adhd", catLabel:"ADHD", type:"èº«è»½+æ•´ç†", name:"ADHD ãƒ„ã‚¤ãƒ« R", code:"5509", price:"16,500", catch:"èº«è»½ã§æ•´ç†", before:"èƒŒè² ã‚ã‚Œã¦ã„ã‚‹æ„Ÿ", after:"å°æŸ„ã«ãƒ•ã‚£ãƒƒãƒˆ", points:"âœ… æœ€è»½é‡\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œå…¨ã¦ã‚¯ãƒªã‚¢ã€", url:"/products/adhd-tr" },
  { id:"R_mothers2", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ãƒãƒ", name:"mother's 2", code:"8604", price:"11,000", catch:"ãƒãƒç”¨æ•´ç†ãƒªãƒ¥ãƒƒã‚¯", before:"å…¨éƒ¨ãã¡ã‚ƒãã¡ã‚ƒ", after:"åˆ†é›¢åç´", points:"âœ… ãƒãƒã®å£°ã§è¨­è¨ˆ\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæ•´ç†ã§ãã‚‹ã€", url:"/products/el8604" },
  { id:"R_fathers", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ãƒ‘ãƒ‘", name:"Father's", code:"8557", price:"13,200", catch:"ãƒ‘ãƒ‘å°‚ç”¨ãƒªãƒ¥ãƒƒã‚¯", before:"è·ç‰©ç®¡ç†ãŒè‹¦æ‰‹", after:"è‡ªä¿¡ã‚’æŒã£ã¦ãŠå‡ºã‹ã‘", points:"âœ… ãƒ‘ãƒ‘å°‚ç”¨è¨­è¨ˆ\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œãƒ‘ãƒ‘ã®ãŸã‚ã€", url:"/products/el8557" },
  { id:"R_hug", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"æ€¥ãªæŠ±ã£ã“å¯¾ç­–", name:"hug", code:"5416", price:"11,000", catch:"æŠ±ã£ã“ç´å†…è”µ", before:"æŠ±ã£ã“ç´å¿˜ã‚ŒãŸ", after:"ã„ã¤ã§ã‚‚å¯¾å¿œ", points:"âœ… æŠ±ã£ã“ç´å†…è”µ\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œå®‰å¿ƒã€", url:"/products/kabag-hug" },
  { id:"R_cold_R", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"æ—¥å¸¸è²·ã„ç‰©", name:"ä¿æ¸©ä¿å†· R", code:"8472", price:"6,490", catch:"ä¿æ¸©ä¿å†·ãƒãƒƒã‚°", before:"å†·å‡å“ãŒæº¶ã‘ã‚‹", after:"å®‰å…¨ã«æŒã¡å¸°ã‚Š", points:"âœ… ä¿æ¸©ä¿å†·\nâœ… 3WAY\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œæ¢ã•ãªããªã£ãŸã€", url:"/products/el8472" },
  { id:"R_cold_L", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ã¾ã¨ã‚è²·ã„", name:"ä¿æ¸©ä¿å†· L", code:"8471", price:"7,590", catch:"å¤§å®¹é‡ä¿æ¸©ä¿å†·", before:"æ½°ã‚Œã‚‹", after:"ãƒªãƒ¥ãƒƒã‚¯ã§æ¥½", points:"âœ… å¤§å®¹é‡\nâœ… 30æ—¥é–“è¿”é‡‘ä¿è¨¼", voice:"ã€Œç‰›ä¹³4æœ¬ä½™è£•ã€", url:"/products/el8471" },
  { id:"R_hayabusa", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ã‚­ãƒƒã‚ºæ–°å¹¹ç·š", name:"E5ç³»ã¯ã‚„ã¶ã•", code:"5439", price:"7,590", catch:"ãŠã‚‚ã¡ã‚ƒç®±ãƒªãƒ¥ãƒƒã‚¯", before:"ä¸­ãŒãã¡ã‚ƒãã¡ã‚ƒ", after:"è‡ªåˆ†ã§ç‰‡ä»˜ã‘ã‚‹", points:"âœ… ã¯ã‚„ã¶ã•ãƒ‡ã‚¶ã‚¤ãƒ³", voice:"ã€Œå¤§äººæ°—ã€", url:"/products/el5439" },
  { id:"R_dryellow", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ã‚­ãƒƒã‚ºDr.Yellow", name:"Dr.Yellow", code:"5438", price:"7,590", catch:"ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚¤ã‚¨ãƒ­ãƒ¼", before:"ä¸­ãŒæ··ã–ã‚‹", after:"è‡ªåˆ†ã§ç‰‡ä»˜ã‘ã‚‹", points:"âœ… Dr.Yellowãƒ‡ã‚¶ã‚¤ãƒ³", voice:"ã€Œç‰¹åˆ¥æ„Ÿã€", url:"/products/el5438" },
  { id:"R_car", cat:"family", catLabel:"ãƒ•ã‚¡ãƒŸãƒªãƒ¼", type:"ã‚­ãƒƒã‚ºãã‚‹ã¾", name:"car", code:"5368", price:"6,490", catch:"ãã‚‹ã¾ãƒªãƒ¥ãƒƒã‚¯", before:"ä¸­ãŒæ··ã–ã‚‹", after:"è‡ªåˆ†ã§ç‰‡ä»˜ã‘ã‚‹", points:"âœ… ãã‚‹ã¾ãƒ‡ã‚¶ã‚¤ãƒ³", voice:"ã€Œè»Šå¥½ãã«ã€", url:"/products/el5368" },
];

const initCfg = { brandColor:"#E67E22", brandColorLight:"#FFF3E8", brandColorDark:"#BF6516", title:"ã‚ãªãŸã«ã´ã£ãŸã‚Šã®\nKABAGãŒè¦‹ã¤ã‹ã‚‹è¨ºæ–­", subtitle:"2æŠã®è³ªå•ã«ç­”ãˆã‚‹ã ã‘", badge:"", maxDepth:7, ctaText:"ã“ã®å•†å“ã‚’è¦‹ã‚‹ â†’", retryText:"ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹" };

const CAT_COLORS = { time:{ bg:"#FFF8E1", border:"#F9A825", text:"#F57F17" }, family:{ bg:"#E8F5E9", border:"#43A047", text:"#2E7D32" }, adhd:{ bg:"#F3E5F5", border:"#8E24AA", text:"#6A1B9A" } };

// Small input
function In({ value, onChange, placeholder="", style={} }) {
  return <input type="text" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} style={{ padding:"4px 6px", border:"1px solid #ddd", borderRadius:4, fontSize:12, width:"100%", fontFamily:"inherit", ...style }} />;
}
function Tx({ value, onChange, rows=2 }) {
  return <textarea value={value} onChange={e=>onChange(e.target.value)} rows={rows} style={{ width:"100%", padding:"4px 6px", border:"1px solid #ddd", borderRadius:4, fontSize:12, fontFamily:"inherit", resize:"vertical", lineHeight:1.4 }} />;
}

function App() {
  const [qs, setQs] = useState(initQ);
  const [rs, setRs] = useState(initR);
  const [cfg, setCfg] = useState(initCfg);
  const [pos, setPos] = useState(() => layoutTree(initQ, initR));
  const [pan, setPan] = useState({ x: 0, y: 0 });
  const [zoom, setZoom] = useState(0.45);
  const [selected, setSelected] = useState(null); // { type:'q'|'r', id }
  const [dragging, setDragging] = useState(null);
  const [panning, setPanning] = useState(false);
  const [panStart, setPanStart] = useState(null);
  const [connecting, setConnecting] = useState(null); // { fromId, slot: 'n1'|'n2', mx, my }
  const [copied, setCopied] = useState(false);
  const [showCfg, setShowCfg] = useState(false);
  const canvasRef = useRef(null);
  const dragOffset = useRef({ x:0, y:0 });

  const allIds = [...qs.map(q=>q.id), ...rs.map(r=>r.id)];
  const qMap = {}; qs.forEach(q => qMap[q.id]=q);
  const rMap = {}; rs.forEach(r => rMap[r.id]=r);

  const NODE_W = 180;
  const NODE_H_Q = 100;
  const NODE_H_R = 64;

  // ===== Mouse handlers for canvas =====
  const getCanvasPoint = (e) => {
    const rect = canvasRef.current.getBoundingClientRect();
    return {
      x: (e.clientX - rect.left - pan.x) / zoom,
      y: (e.clientY - rect.top - pan.y) / zoom
    };
  };

  const onCanvasMouseDown = (e) => {
    if (e.target === canvasRef.current || e.target.tagName === 'svg' || e.target.tagName === 'line' || e.target.tagName === 'path') {
      setPanning(true);
      setPanStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
      setSelected(null);
    }
  };

  const onCanvasMouseMove = (e) => {
    if (panning && panStart) {
      setPan({ x: e.clientX - panStart.x, y: e.clientY - panStart.y });
    }
    if (dragging) {
      const p = getCanvasPoint(e);
      setPos(prev => ({ ...prev, [dragging]: { x: p.x - dragOffset.current.x, y: p.y - dragOffset.current.y } }));
    }
    if (connecting) {
      const rect = canvasRef.current.getBoundingClientRect();
      setConnecting(prev => prev ? { ...prev, mx: e.clientX - rect.left, my: e.clientY - rect.top } : null);
    }
  };

  const onCanvasMouseUp = (e) => {
    if (connecting) {
      // Check if dropped on a node
      const p = getCanvasPoint(e);
      let target = null;
      allIds.forEach(id => {
        const np = pos[id];
        if (np && p.x >= np.x && p.x <= np.x + NODE_W && p.y >= np.y && p.y <= np.y + 120) {
          target = id;
        }
      });
      if (target && target !== connecting.fromId) {
        const idx = qs.findIndex(q => q.id === connecting.fromId);
        if (idx >= 0) {
          const nq = [...qs];
          nq[idx] = { ...nq[idx], [connecting.slot]: target };
          setQs(nq);
        }
      }
      setConnecting(null);
    }
    setPanning(false);
    setPanStart(null);
    setDragging(null);
  };

  const onWheel = (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.05 : 0.05;
    setZoom(z => Math.max(0.15, Math.min(2, z + delta)));
  };

  useEffect(() => {
    const el = canvasRef.current;
    if (el) el.addEventListener('wheel', onWheel, { passive: false });
    return () => { if (el) el.removeEventListener('wheel', onWheel); };
  }, []);

  const startDrag = (id, e) => {
    e.stopPropagation();
    const p = getCanvasPoint(e);
    const np = pos[id] || { x: 0, y: 0 };
    dragOffset.current = { x: p.x - np.x, y: p.y - np.y };
    setDragging(id);
    setSelected(qMap[id] ? { type:'q', id } : rMap[id] ? { type:'r', id } : null);
  };

  const startConnect = (fromId, slot, e) => {
    e.stopPropagation();
    const rect = canvasRef.current.getBoundingClientRect();
    setConnecting({ fromId, slot, mx: e.clientX - rect.left, my: e.clientY - rect.top });
  };

  // ===== Draw connections =====
  const renderConnections = () => {
    const lines = [];
    qs.forEach(q => {
      const from = pos[q.id];
      if (!from) return;
      [['n1', '#E67E22'], ['n2', '#3498DB']].forEach(([slot, color]) => {
        const tid = q[slot];
        const to = tid ? pos[tid] : null;
        if (from && to) {
          const x1 = from.x + (slot === 'n1' ? NODE_W * 0.3 : NODE_W * 0.7);
          const y1 = from.y + NODE_H_Q;
          const x2 = to.x + NODE_W / 2;
          const y2 = to.y;
          const my = (y1 + y2) / 2;
          lines.push(
            <path key={q.id+slot} d={`M${x1},${y1} C${x1},${my} ${x2},${my} ${x2},${y2}`}
              fill="none" stroke={color} strokeWidth={2.5} strokeOpacity={0.7} />
          );
          // Arrow
          lines.push(
            <polygon key={q.id+slot+"a"} points={`${x2-4},${y2-6} ${x2+4},${y2-6} ${x2},${y2}`} fill={color} opacity={0.7} />
          );
        }
      });
    });

    // Connecting line
    if (connecting) {
      const from = pos[connecting.fromId];
      if (from) {
        const x1 = from.x + (connecting.slot === 'n1' ? NODE_W * 0.3 : NODE_W * 0.7);
        const y1 = from.y + NODE_H_Q;
        const x2 = (connecting.mx - pan.x) / zoom;
        const y2 = (connecting.my - pan.y) / zoom;
        lines.push(
          <line key="connecting" x1={x1} y1={y1} x2={x2} y2={y2} stroke="#E67E22" strokeWidth={2} strokeDasharray="6,4" opacity={0.8} />
        );
      }
    }
    return lines;
  };

  // ===== Node components =====
  const QNode = ({ q }) => {
    const p = pos[q.id] || { x:0, y:0 };
    const isSel = selected?.id === q.id;
    return (
      <div onMouseDown={e => startDrag(q.id, e)} style={{
        position:"absolute", left: p.x, top: p.y, width: NODE_W,
        background:"#fff", border: isSel ? "3px solid #E67E22" : "2px solid #ccc",
        borderRadius:10, boxShadow: isSel ? "0 0 0 3px rgba(230,126,34,0.2)" : "0 2px 8px rgba(0,0,0,0.08)",
        cursor: dragging === q.id ? "grabbing" : "grab", userSelect:"none", zIndex: isSel ? 10 : 1, transition: dragging === q.id ? "none" : "box-shadow 0.2s"
      }}>
        {/* Header */}
        <div style={{ background:"#f8f8f8", borderRadius:"8px 8px 0 0", padding:"6px 10px", display:"flex", justifyContent:"space-between", alignItems:"center", borderBottom:"1px solid #eee" }}>
          <span style={{ fontSize:10, fontWeight:700, color:"#E67E22" }}>{q.id}</span>
          <span style={{ fontSize:9, color:"#999" }}>è³ªå•</span>
        </div>
        {/* Body */}
        <div style={{ padding:"8px 10px" }}>
          <div style={{ fontSize:12, fontWeight:600, lineHeight:1.3, color:"#333", minHeight:28 }}>{q.text.split('\n')[0]}</div>
        </div>
        {/* Connectors */}
        <div style={{ display:"flex", borderTop:"1px solid #eee" }}>
          <div onMouseDown={e => startConnect(q.id, 'n1', e)}
            style={{ flex:1, padding:"5px", textAlign:"center", fontSize:9, color:"#E67E22", cursor:"crosshair", borderRight:"1px solid #eee", background:"#FFF8F0", borderRadius:"0 0 0 8px" }}
            title="é¸æŠè‚¢1ã®æ¥ç¶šå…ˆã‚’ãƒ‰ãƒ©ãƒƒã‚°">
            {q.icon1} {q.n1 || "â€”"}
          </div>
          <div onMouseDown={e => startConnect(q.id, 'n2', e)}
            style={{ flex:1, padding:"5px", textAlign:"center", fontSize:9, color:"#3498DB", cursor:"crosshair", background:"#F0F8FF", borderRadius:"0 0 8px 0" }}
            title="é¸æŠè‚¢2ã®æ¥ç¶šå…ˆã‚’ãƒ‰ãƒ©ãƒƒã‚°">
            {q.icon2} {q.n2 || "â€”"}
          </div>
        </div>
      </div>
    );
  };

  const RNode = ({ r }) => {
    const p = pos[r.id] || { x:0, y:0 };
    const isSel = selected?.id === r.id;
    const cc = CAT_COLORS[r.cat] || CAT_COLORS.time;
    return (
      <div onMouseDown={e => startDrag(r.id, e)} style={{
        position:"absolute", left: p.x, top: p.y, width: NODE_W,
        background: cc.bg, border: isSel ? `3px solid ${cc.border}` : `2px solid ${cc.border}`,
        borderRadius:10, boxShadow: isSel ? `0 0 0 3px ${cc.border}40` : "0 2px 8px rgba(0,0,0,0.06)",
        cursor: dragging === r.id ? "grabbing" : "grab", userSelect:"none", zIndex: isSel ? 10 : 1
      }}>
        <div style={{ padding:"8px 10px" }}>
          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:4 }}>
            <span style={{ fontSize:9, fontWeight:700, color:cc.text, background:"#fff", padding:"1px 6px", borderRadius:8 }}>{r.catLabel}</span>
            <span style={{ fontSize:10, fontWeight:700, color:cc.text }}>Â¥{r.price}</span>
          </div>
          <div style={{ fontSize:12, fontWeight:700, color:"#333" }}>{r.name.split('\n')[0]}</div>
          <div style={{ fontSize:9, color:"#888", marginTop:2 }}>{r.id}</div>
        </div>
      </div>
    );
  };

  // ===== Side Panel =====
  const sel = selected ? (selected.type === 'q' ? qMap[selected.id] : rMap[selected.id]) : null;
  const selIdx = selected ? (selected.type === 'q' ? qs.findIndex(q=>q.id===selected.id) : rs.findIndex(r=>r.id===selected.id)) : -1;
  const uQ = (f,v) => { const n=[...qs]; n[selIdx]={...n[selIdx],[f]:v}; setQs(n); };
  const uR = (f,v) => { const n=[...rs]; n[selIdx]={...n[selIdx],[f]:v}; setRs(n); };

  const deleteNode = () => {
    if (!selected) return;
    if (selected.type === 'q') {
      if (qs.length <= 1) return;
      setQs(qs.filter(q => q.id !== selected.id));
    } else {
      if (rs.length <= 1) return;
      setRs(rs.filter(r => r.id !== selected.id));
    }
    const np = {...pos}; delete np[selected.id]; setPos(np);
    setSelected(null);
  };

  const addNode = (type) => {
    const vp = getCanvasPoint({ clientX: canvasRef.current.getBoundingClientRect().width/2 + canvasRef.current.getBoundingClientRect().left, clientY: canvasRef.current.getBoundingClientRect().height/2 + canvasRef.current.getBoundingClientRect().top });
    const id = type === 'q' ? "Q_" + Date.now().toString(36) : "R_" + Date.now().toString(36);
    setPos(prev => ({ ...prev, [id]: { x: vp.x - 90, y: vp.y - 40 } }));
    if (type === 'q') {
      const nq = { id, label:"NEW", text:"æ–°ã—ã„è³ªå•", desc:"", icon1:"ğŸ‘ˆ", icon2:"ğŸ‘‰", c1:"é¸æŠè‚¢1", c1sub:"", c2:"é¸æŠè‚¢2", c2sub:"", n1:"", n2:"" };
      setQs([...qs, nq]);
      setSelected({ type:'q', id });
    } else {
      const nr = { id, cat:"time", catLabel:"æ™‚çŸ­", type:"ã‚¿ã‚¤ãƒ—å", name:"æ–°ã—ã„å•†å“", code:"", price:"0", catch:"", before:"", after:"", points:"", voice:"", url:"/" };
      setRs([...rs, nr]);
      setSelected({ type:'r', id });
    }
  };

  // ===== HTML Generation =====
  const genHTML = useCallback(() => {
    const qo={}; qs.forEach(q=>{ qo[q.id]={label:q.label,text:q.text,desc:q.desc,icon1:q.icon1,icon2:q.icon2,c1:q.c1,c1sub:q.c1sub,c2:q.c2,c2sub:q.c2sub,n1:q.n1,n2:q.n2}; });
    const ro={}; rs.forEach(r=>{ ro[r.id]={cat:r.cat,catLabel:r.catLabel,type:r.type,name:r.name,code:r.code,price:r.price,catch:r.catch,before:r.before,after:r.after,points:r.points,voice:r.voice,url:r.url}; });
    return `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');*{margin:0;padding:0;box-sizing:border-box}.kd{--a:${cfg.brandColor};--al:${cfg.brandColorLight};--ad:${cfg.brandColorDark};font-family:'Noto Sans JP',sans-serif;color:#333;background:#FAFAFA;max-width:560px;margin:0 auto;padding:20px 16px}.kd h1{font-size:22px;font-weight:900;line-height:1.4;text-align:center;margin-bottom:6px}.kd .sub{font-size:13px;color:#777;text-align:center;margin-bottom:24px}.kd .bar{display:flex;align-items:center;gap:8px;margin-bottom:24px}.kd .bar-bg{flex:1;height:4px;background:#E8E8E8;border-radius:4px;overflow:hidden}.kd .bar-fill{height:100%;background:var(--a);border-radius:4px;transition:width .5s}.kd .bar-txt{font-size:12px;font-weight:700;color:var(--a);min-width:40px;text-align:right}.kd .card{background:#fff;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,.06);padding:24px;animation:fi .4s}@keyframes fi{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}.kd .ql{font-size:12px;font-weight:700;color:var(--a);margin-bottom:8px}.kd .qt{font-size:18px;font-weight:700;line-height:1.5;margin-bottom:8px}.kd .qd{font-size:13px;color:#777;line-height:1.7;margin-bottom:20px}.kd .chs{display:flex;flex-direction:column;gap:10px}.kd .ch{display:flex;align-items:center;gap:14px;padding:16px;border:2px solid #E8E8E8;border-radius:12px;cursor:pointer;transition:.3s;background:#fff}.kd .ch:hover{border-color:var(--a);background:var(--al);box-shadow:0 4px 24px rgba(0,0,0,.1);transform:translateY(-1px)}.kd .ci{width:36px;height:36px;border-radius:50%;background:#FAFAFA;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:.3s}.kd .ch:hover .ci{background:var(--a);color:#fff}.kd .ct{font-size:14px;font-weight:500;line-height:1.5}.kd .cs{font-size:12px;color:#777;margin-top:2px}.kd .bk{display:inline-flex;align-items:center;gap:4px;margin-top:16px;padding:8px 12px;font-size:13px;color:#777;background:none;border:none;cursor:pointer;border-radius:8px}.kd .bk:hover{background:#FAFAFA;color:#333}.kd .res{animation:fi .5s}.kd .rt{display:inline-block;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:700;margin-bottom:12px}.kd .rt.time{background:#FFF8E1;color:#D4A017}.kd .rt.family{background:#E8F5E9;color:#2E7D32}.kd .rt.adhd{background:#F3E5F5;color:#6A1B9A}.kd .rn{font-size:24px;font-weight:900;line-height:1.3;margin-bottom:6px}.kd .rc{font-size:15px;color:#777;line-height:1.6;margin-bottom:20px}.kd .ba{display:flex;gap:12px;margin-bottom:20px}.kd .bx{flex:1;padding:16px;border-radius:12px;font-size:13px;line-height:1.7}.kd .bx.bf{background:#FFF3F3;border:1px solid #FFCDD2}.kd .bx.af{background:#E8F5E9;border:1px solid #A5D6A7}.kd .bl{font-size:11px;font-weight:700;margin-bottom:6px;display:block}.kd .bx.bf .bl{color:#C62828}.kd .bx.af .bl{color:#2E7D32}.kd .pts{background:#FAFAFA;border-radius:12px;padding:16px;margin-bottom:16px;font-size:13px;line-height:1.8}.kd .vc{background:var(--al);border-radius:12px;padding:16px;margin-bottom:20px;font-size:13px;line-height:1.7;font-style:italic}.kd .pd{background:#fff;border:2px solid #E8E8E8;border-radius:12px;padding:20px;margin-bottom:16px}.kd .pn{font-size:15px;font-weight:700;margin-bottom:4px}.kd .pp{font-size:20px;font-weight:900;color:var(--a)}.kd .pp small{font-size:12px;color:#777}.kd .cta{display:block;width:100%;padding:16px;background:var(--a);color:#fff;font-size:16px;font-weight:700;text-align:center;border:none;border-radius:12px;cursor:pointer;text-decoration:none;margin-bottom:10px}.kd .cta:hover{background:var(--ad)}.kd .ry{display:block;width:100%;padding:12px;background:none;color:#777;font-size:14px;text-align:center;border:1px solid #E8E8E8;border-radius:12px;cursor:pointer}@media(max-width:480px){.kd{padding:16px 12px}.kd h1{font-size:19px}.kd .qt{font-size:16px}.kd .ba{flex-direction:column;gap:8px}.kd .rn{font-size:20px}.kd .card{padding:20px 16px}}</style></head><body><div class="kd" id="K"><div style="text-align:center;margin-bottom:24px">${cfg.badge?`<span style="display:inline-block;background:var(--a);color:#fff;font-size:11px;font-weight:700;padding:4px 14px;border-radius:20px;margin-bottom:10px">${cfg.badge}</span>`:''}<h1>${cfg.title.replace(/\n/g,'<br>')}</h1><p class="sub">${cfg.subtitle}</p></div><div class="bar"><div class="bar-bg"><div class="bar-fill" id="pF"></div></div><div class="bar-txt" id="pT"></div></div><div id="C"></div></div><script>(function(){var Q=${JSON.stringify(qo)};var R=${JSON.stringify(ro)};var M=${cfg.maxDepth};var h=[];var c;var ct=document.getElementById('C'),pf=document.getElementById('pF'),pt=document.getElementById('pT');function n(s){return(s||'').replace(/\\n/g,'<br>')}function u(){var d=h.length+1;pf.style.width=Math.min(d/M*100,95)+'%';pt.textContent=d+'/'+M}function sQ(id){c=id;var q=Q[id];if(!q)return;u();var dh=q.desc?'<div class="qd"'+(id.indexOf("A")>-1?' style="background:#F3E5F5;padding:14px;border-radius:8px;border-left:3px solid #6A1B9A;color:#4A148C"':'')+'>'+n(q.desc)+'</div>':'';var bk=h.length?'<button class="bk" onclick="B()">â† æˆ»ã‚‹</button>':'';ct.innerHTML='<div class="card"><div class="ql">'+q.label+'</div><div class="qt">'+n(q.text)+'</div>'+dh+'<div class="chs"><div class="ch" onclick="C(\\''+q.n1+'\\')"><div class="ci">'+q.icon1+'</div><div><div class="ct">'+n(q.c1)+'</div>'+(q.c1sub?'<div class="cs">'+q.c1sub+'</div>':'')+'</div></div><div class="ch" onclick="C(\\''+q.n2+'\\')"><div class="ci">'+q.icon2+'</div><div><div class="ct">'+n(q.c2)+'</div>'+(q.c2sub?'<div class="cs">'+q.c2sub+'</div>':'')+'</div></div></div>'+bk+'</div>'}function sR(id){var r=R[id];if(!r)return;pf.style.width='100%';pt.textContent='å®Œäº†ï¼';ct.innerHTML='<div class="res"><div class="rt '+r.cat+'">'+r.catLabel+'</div><div style="font-size:13px;color:#777;margin-bottom:4px">ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—</div><div class="rn">'+n(r.type)+'</div><div class="rc">'+n(r.catch)+'</div><div class="ba"><div class="bx bf"><span class="bl">ğŸ˜¥ ä»Šã®ã‚ãªãŸ</span>'+n(r.before)+'</div><div class="bx af"><span class="bl">âœ¨ KABAGã‚’ä½¿ã†ã¨</span>'+n(r.after)+'</div></div><div class="pts">'+n(r.points)+'</div><div class="vc">ğŸ’¬ '+n(r.voice)+'</div><div class="pd"><div class="pn">'+n(r.name)+'</div><div class="pp">Â¥'+r.price+' <small>ï¼ˆç¨è¾¼ãƒ»é€æ–™ç„¡æ–™ï¼‰</small></div></div><a class="cta" href="'+r.url+'">${cfg.ctaText}</a><button class="ry" onclick="X()">${cfg.retryText}</button></div>'}window.C=function(x){h.push(c);x.indexOf("R_")===0?sR(x):sQ(x);document.getElementById("K").scrollIntoView({behavior:"smooth",block:"start"})};window.B=function(){if(h.length)sQ(h.pop())};window.X=function(){h=[];sQ("${qs[0]?.id||'Q1'}")};sQ("${qs[0]?.id||'Q1'}");})();<\/script></body></html>`;
  }, [qs, rs, cfg]);

  const handleCopy = () => { navigator.clipboard.writeText(genHTML()).then(()=>{ setCopied(true); setTimeout(()=>setCopied(false),2000); }); };

  const SL = { lbl:{ display:"block", fontSize:10, fontWeight:600, color:"#888", marginBottom:2, marginTop:6 } };

  return (
    <div style={{ fontFamily:"system-ui, sans-serif", height:"100vh", display:"flex", flexDirection:"column", background:"#1a1a2e", overflow:"hidden" }}>
      {/* Top bar */}
      <div style={{ background:"#16213e", padding:"6px 12px", display:"flex", alignItems:"center", justifyContent:"space-between", borderBottom:"1px solid #0f3460", flexShrink:0 }}>
        <div style={{ display:"flex", alignItems:"center", gap:8 }}>
          <span style={{ fontSize:14, fontWeight:900, color:"#E67E22" }}>KABAG</span>
          <span style={{ fontSize:11, color:"#888" }}>ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</span>
          <span style={{ fontSize:10, color:"#555", marginLeft:8 }}>Q:{qs.length} R:{rs.length}</span>
        </div>
        <div style={{ display:"flex", gap:6 }}>
          <button onClick={() => addNode('q')} style={{ padding:"4px 10px", fontSize:11, fontWeight:700, border:"1px solid #E67E22", borderRadius:6, cursor:"pointer", background:"transparent", color:"#E67E22" }}>ï¼‹ è³ªå•</button>
          <button onClick={() => addNode('r')} style={{ padding:"4px 10px", fontSize:11, fontWeight:700, border:"1px solid #43A047", borderRadius:6, cursor:"pointer", background:"transparent", color:"#43A047" }}>ï¼‹ çµæœ</button>
          <div style={{ width:1, background:"#333", margin:"0 4px" }} />
          <button onClick={() => setShowCfg(!showCfg)} style={{ padding:"4px 10px", fontSize:11, fontWeight:600, border:"1px solid #555", borderRadius:6, cursor:"pointer", background: showCfg?"#333":"transparent", color:"#aaa" }}>âš™</button>
          <button onClick={handleCopy} style={{ padding:"4px 10px", fontSize:11, fontWeight:700, border:"none", borderRadius:6, cursor:"pointer", background: copied?"#27AE60":"#E67E22", color:"#fff" }}>{copied?"âœ… ã‚³ãƒ”ãƒ¼æ¸ˆ":"ğŸ“‹ HTMLå‡ºåŠ›"}</button>
        </div>
      </div>

      <div style={{ flex:1, display:"flex", overflow:"hidden" }}>
        {/* Canvas */}
        <div ref={canvasRef} onMouseDown={onCanvasMouseDown} onMouseMove={onCanvasMouseMove} onMouseUp={onCanvasMouseUp} onMouseLeave={onCanvasMouseUp}
          style={{ flex:1, position:"relative", overflow:"hidden", cursor: panning?"grabbing":"default", background:"#1a1a2e",
            backgroundImage:"radial-gradient(circle, #2a2a4e 1px, transparent 1px)", backgroundSize: `${20*zoom}px ${20*zoom}px`,
            backgroundPosition: `${pan.x}px ${pan.y}px`
          }}>
          {/* Zoom controls */}
          <div style={{ position:"absolute", bottom:12, left:12, display:"flex", gap:4, zIndex:20 }}>
            <button onClick={()=>setZoom(z=>Math.min(2,z+0.1))} style={{ width:28, height:28, borderRadius:6, border:"1px solid #444", background:"#222", color:"#aaa", cursor:"pointer", fontSize:14 }}>+</button>
            <button onClick={()=>setZoom(z=>Math.max(0.15,z-0.1))} style={{ width:28, height:28, borderRadius:6, border:"1px solid #444", background:"#222", color:"#aaa", cursor:"pointer", fontSize:14 }}>âˆ’</button>
            <span style={{ color:"#666", fontSize:10, lineHeight:"28px", marginLeft:4 }}>{Math.round(zoom*100)}%</span>
          </div>
          <div style={{ position:"absolute", bottom:12, right:12, fontSize:10, color:"#444", zIndex:20 }}>
            ãƒ‰ãƒ©ãƒƒã‚°: ãƒãƒ¼ãƒ‰ç§»å‹• ï½œ èƒŒæ™¯ãƒ‰ãƒ©ãƒƒã‚°: ãƒ‘ãƒ³ ï½œ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ  ï½œ ä¸‹éƒ¨ã‚³ãƒã‚¯ã‚¿â†’ãƒãƒ¼ãƒ‰: æ¥ç¶š
          </div>

          {/* Transform layer */}
          <div style={{ transform:`translate(${pan.x}px,${pan.y}px) scale(${zoom})`, transformOrigin:"0 0", position:"absolute", top:0, left:0 }}>
            {/* SVG connections */}
            <svg style={{ position:"absolute", top:0, left:0, width:8000, height:8000, pointerEvents:"none", overflow:"visible" }}>
              {renderConnections()}
            </svg>
            {/* Nodes */}
            {qs.map(q => <QNode key={q.id} q={q} />)}
            {rs.map(r => <RNode key={r.id} r={r} />)}
          </div>
        </div>

        {/* Side panel */}
        {(selected && sel) && (
          <div style={{ width:280, background:"#16213e", borderLeft:"1px solid #0f3460", overflowY:"auto", flexShrink:0, padding:12 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
              <span style={{ fontSize:13, fontWeight:700, color:"#fff" }}>{selected.type==='q'?'â“ è³ªå•':'ğŸ¯ çµæœ'}</span>
              <div style={{ display:"flex", gap:4 }}>
                <button onClick={deleteNode} style={{ padding:"3px 8px", fontSize:10, border:"1px solid #C62828", borderRadius:4, cursor:"pointer", background:"transparent", color:"#EF9A9A" }}>ğŸ—‘ å‰Šé™¤</button>
                <button onClick={()=>setSelected(null)} style={{ padding:"3px 8px", fontSize:10, border:"1px solid #555", borderRadius:4, cursor:"pointer", background:"transparent", color:"#888" }}>âœ•</button>
              </div>
            </div>

            {selected.type === 'q' && selIdx >= 0 && (() => {
              const q = qs[selIdx];
              return (
                <div style={{ display:"flex", flexDirection:"column", gap:2 }}>
                  <label style={SL.lbl}>ID</label><In value={q.id} onChange={v=>uQ("id",v)} />
                  <label style={SL.lbl}>ãƒ©ãƒ™ãƒ«</label><In value={q.label} onChange={v=>uQ("label",v)} />
                  <label style={SL.lbl}>è³ªå•æ–‡</label><Tx value={q.text} onChange={v=>uQ("text",v)} />
                  <label style={SL.lbl}>è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆ</label><Tx value={q.desc} onChange={v=>uQ("desc",v)} rows={3} />
                  <div style={{ display:"flex", gap:4 }}>
                    <div style={{ flex:1 }}><label style={SL.lbl}>icon1</label><In value={q.icon1} onChange={v=>uQ("icon1",v)} /></div>
                    <div style={{ flex:1 }}><label style={SL.lbl}>icon2</label><In value={q.icon2} onChange={v=>uQ("icon2",v)} /></div>
                  </div>
                  <div style={{ background:"#1e2a47", padding:8, borderRadius:6, marginTop:4 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:"#E67E22", marginBottom:4 }}>é¸æŠè‚¢1</div>
                    <Tx value={q.c1} onChange={v=>uQ("c1",v)} />
                    <In value={q.c1sub} onChange={v=>uQ("c1sub",v)} placeholder="ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ" style={{ marginTop:3 }} />
                    <label style={SL.lbl}>é·ç§»å…ˆ</label>
                    <select value={q.n1} onChange={e=>uQ("n1",e.target.value)} style={{ width:"100%", padding:4, border:"1px solid #444", borderRadius:4, fontSize:11, background:"#0f1a30", color:"#ddd" }}>
                      <option value="">-- é¸æŠ --</option>
                      {allIds.map(t=><option key={t} value={t}>{t.startsWith("R_")?"ğŸ¯":"â“"} {t}</option>)}
                    </select>
                  </div>
                  <div style={{ background:"#1a2740", padding:8, borderRadius:6, marginTop:4 }}>
                    <div style={{ fontSize:10, fontWeight:700, color:"#3498DB", marginBottom:4 }}>é¸æŠè‚¢2</div>
                    <Tx value={q.c2} onChange={v=>uQ("c2",v)} />
                    <In value={q.c2sub} onChange={v=>uQ("c2sub",v)} placeholder="ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ" style={{ marginTop:3 }} />
                    <label style={SL.lbl}>é·ç§»å…ˆ</label>
                    <select value={q.n2} onChange={e=>uQ("n2",e.target.value)} style={{ width:"100%", padding:4, border:"1px solid #444", borderRadius:4, fontSize:11, background:"#0f1a30", color:"#ddd" }}>
                      <option value="">-- é¸æŠ --</option>
                      {allIds.map(t=><option key={t} value={t}>{t.startsWith("R_")?"ğŸ¯":"â“"} {t}</option>)}
                    </select>
                  </div>
                </div>
              );
            })()}

            {selected.type === 'r' && selIdx >= 0 && (() => {
              const r = rs[selIdx];
              return (
                <div style={{ display:"flex", flexDirection:"column", gap:2 }}>
                  <label style={SL.lbl}>ID</label><In value={r.id} onChange={v=>uR("id",v)} />
                  <label style={SL.lbl}>ã‚«ãƒ†ã‚´ãƒª</label>
                  <select value={r.cat} onChange={e=>{uR("cat",e.target.value)}} style={{ width:"100%", padding:4, border:"1px solid #444", borderRadius:4, fontSize:11, background:"#0f1a30", color:"#ddd" }}>
                    <option value="time">æ™‚çŸ­</option><option value="family">ãƒ•ã‚¡ãƒŸãƒªãƒ¼</option><option value="adhd">ADHD</option>
                  </select>
                  <label style={SL.lbl}>ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºå</label><In value={r.catLabel} onChange={v=>uR("catLabel",v)} />
                  <label style={SL.lbl}>å•†å“å</label><In value={r.name} onChange={v=>uR("name",v)} />
                  <div style={{ display:"flex", gap:4 }}>
                    <div style={{ flex:1 }}><label style={SL.lbl}>å‹ç•ª</label><In value={r.code} onChange={v=>uR("code",v)} /></div>
                    <div style={{ flex:1 }}><label style={SL.lbl}>ä¾¡æ ¼</label><In value={r.price} onChange={v=>uR("price",v)} /></div>
                  </div>
                  <label style={SL.lbl}>ã‚¿ã‚¤ãƒ—å</label><In value={r.type} onChange={v=>uR("type",v)} />
                  <label style={SL.lbl}>ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</label><Tx value={r.catch} onChange={v=>uR("catch",v)} />
                  <div style={{ display:"flex", gap:4 }}>
                    <div style={{ flex:1 }}><label style={{...SL.lbl,color:"#EF9A9A"}}>ãƒ“ãƒ•ã‚©ãƒ¼</label><Tx value={r.before} onChange={v=>uR("before",v)} rows={3} /></div>
                    <div style={{ flex:1 }}><label style={{...SL.lbl,color:"#A5D6A7"}}>ã‚¢ãƒ•ã‚¿ãƒ¼</label><Tx value={r.after} onChange={v=>uR("after",v)} rows={3} /></div>
                  </div>
                  <label style={SL.lbl}>ãƒã‚¤ãƒ³ãƒˆ</label><Tx value={r.points} onChange={v=>uR("points",v)} rows={3} />
                  <label style={SL.lbl}>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£°</label><Tx value={r.voice} onChange={v=>uR("voice",v)} />
                  <label style={SL.lbl}>URL</label><In value={r.url} onChange={v=>uR("url",v)} />
                </div>
              );
            })()}
          </div>
        )}

        {/* Config panel */}
        {showCfg && (
          <div style={{ width:260, background:"#16213e", borderLeft:"1px solid #0f3460", overflowY:"auto", flexShrink:0, padding:12 }}>
            <div style={{ display:"flex", justifyContent:"space-between", marginBottom:8 }}>
              <span style={{ fontSize:13, fontWeight:700, color:"#fff" }}>âš™ è¨­å®š</span>
              <button onClick={()=>setShowCfg(false)} style={{ background:"none", border:"1px solid #555", borderRadius:4, color:"#888", cursor:"pointer", padding:"2px 6px", fontSize:10 }}>âœ•</button>
            </div>
            <label style={SL.lbl}>ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼</label>
            <div style={{ display:"flex", gap:4 }}><input type="color" value={cfg.brandColor} onChange={e=>setCfg({...cfg,brandColor:e.target.value})} style={{ width:30, height:24, border:"none", cursor:"pointer" }} /><In value={cfg.brandColor} onChange={v=>setCfg({...cfg,brandColor:v})} /></div>
            <label style={SL.lbl}>ãƒ©ã‚¤ãƒˆã‚«ãƒ©ãƒ¼</label><In value={cfg.brandColorLight} onChange={v=>setCfg({...cfg,brandColorLight:v})} />
            <label style={SL.lbl}>ãƒ€ãƒ¼ã‚¯ã‚«ãƒ©ãƒ¼</label><In value={cfg.brandColorDark} onChange={v=>setCfg({...cfg,brandColorDark:v})} />
            <label style={SL.lbl}>ã‚¿ã‚¤ãƒˆãƒ«</label><Tx value={cfg.title} onChange={v=>setCfg({...cfg,title:v})} />
            <label style={SL.lbl}>ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</label><In value={cfg.subtitle} onChange={v=>setCfg({...cfg,subtitle:v})} />
            <label style={SL.lbl}>ãƒãƒƒã‚¸ï¼ˆç©º=éè¡¨ç¤ºï¼‰</label><In value={cfg.badge} onChange={v=>setCfg({...cfg,badge:v})} />
            <label style={SL.lbl}>æœ€å¤§è³ªå•æ•°</label><In value={String(cfg.maxDepth)} onChange={v=>setCfg({...cfg,maxDepth:Number(v)||7})} />
            <label style={SL.lbl}>CTAãƒœã‚¿ãƒ³</label><In value={cfg.ctaText} onChange={v=>setCfg({...cfg,ctaText:v})} />
            <label style={SL.lbl}>ãƒªãƒˆãƒ©ã‚¤</label><In value={cfg.retryText} onChange={v=>setCfg({...cfg,retryText:v})} />
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
